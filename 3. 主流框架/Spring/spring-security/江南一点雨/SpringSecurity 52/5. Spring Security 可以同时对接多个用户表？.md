# Spring Security å¯ä»¥åŒæ—¶å¯¹æ¥å¤šä¸ªç”¨æˆ·è¡¨ï¼Ÿ

Original æ±Ÿå—ä¸€ç‚¹é›¨ [æ±Ÿå—ä¸€ç‚¹é›¨](javascript:void(0);) *2020å¹´07æœˆ14æ—¥ 08:08*

æ¾å“¥åŸåˆ›çš„ Spring Boot è§†é¢‘æ•™ç¨‹å·²ç»æ€é’ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´æˆ³è¿™é‡Œ-->[ğŸ‘‰Spring Boot+Vue+å¾®äººäº‹è§†é¢‘æ•™ç¨‹](https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247488799&idx=1&sn=cdfd5315ff18c979b6f5d390ab4d9059&scene=21#wechat_redirect)

è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯æ¥è‡ªå°ä¼™ä¼´çš„æé—®ï¼š

![Image](img/640-1730174848788.webp)

å…¶å®è¿™ä¸ªé—®é¢˜æœ‰å¥½å‡ ä½å°ä¼™ä¼´é—®è¿‡æˆ‘ï¼Œä½†æ˜¯è¿™ä¸ªéœ€æ±‚æ¯”è¾ƒå†·é—¨ï¼Œæˆ‘ä¸€ç›´æ²¡å†™æ–‡ç« ã€‚

å…¶å®åªè¦çœ‹æ‡‚äº†æ¾å“¥å‰é¢çš„æ–‡ç« ï¼Œè¿™ä¸ªéœ€æ±‚æ˜¯å¯ä»¥åšå‡ºæ¥çš„ã€‚å› ä¸ºä¸€ä¸ªæ ¸å¿ƒç‚¹å°±æ˜¯ ProviderManagerï¼Œææ‡‚äº†è¿™ä¸ªï¼Œå…¶ä»–çš„å°±å¾ˆå®¹æ˜“äº†ã€‚

ä»Šå¤©æ¾å“¥èŠ±ä¸€ç‚¹æ—¶é—´ï¼Œæ¥å’Œå¤§å®¶åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒï¼ŒåŒæ—¶é€šè¿‡ä¸€ä¸ªå°å°æ¡ˆä¾‹æ¥æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åŒæ—¶è¿æ¥å¤šä¸ªæ•°æ®æºã€‚

## 1.åŸç†

### 1.1 Authentication

ç©è¿‡ Spring Security çš„å°ä¼™ä¼´éƒ½çŸ¥é“ï¼Œåœ¨ Spring Security ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å¯¹è±¡å«åš Authenticationï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥ Authentication è¿›è€Œè·å–åˆ°å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ŒAuthentication æœ¬èº«æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå®é™…ä¸Šå¯¹ java.security.Principal åšçš„è¿›ä¸€æ­¥å°è£…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ Authentication çš„å®šä¹‰ï¼š

```
public interface Authentication extends Principal, Serializable {
 Collection<? extends GrantedAuthority> getAuthorities();
 Object getCredentials();
 Object getDetails();
 Object getPrincipal();
 boolean isAuthenticated();
 void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ¥å£ä¸­çš„æ–¹æ³•ä¹Ÿæ²¡å‡ ä¸ªï¼Œæˆ‘æ¥å¤§æ¦‚è§£é‡Šä¸‹ï¼š

1. getAuthorities æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·çš„æƒé™ã€‚
2. getCredentials æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·å‡­è¯ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯å¯†ç ã€‚
3. getDetails æ–¹æ³•ç”¨æ¥è·å–ç”¨æˆ·æºå¸¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å½“å‰è¯·æ±‚ä¹‹ç±»çš„ä¸œè¥¿ã€‚
4. getPrincipal æ–¹æ³•ç”¨æ¥è·å–å½“å‰ç”¨æˆ·ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·åï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ã€‚
5. isAuthenticated å½“å‰ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸã€‚

Authentication ä½œä¸ºä¸€ä¸ªæ¥å£ï¼Œå®ƒå®šä¹‰äº†ç”¨æˆ·ï¼Œæˆ–è€…è¯´ Principal çš„ä¸€äº›åŸºæœ¬è¡Œä¸ºï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ç±»ï¼š

![Image](img/640-1730174848400.webp)

åœ¨è¿™äº›å®ç°ç±»ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ UsernamePasswordAuthenticationToken äº†ï¼Œè€Œæ¯ä¸€ä¸ª Authentication éƒ½æœ‰é€‚åˆå®ƒçš„ AuthenticationProvider å»å¤„ç†æ ¡éªŒã€‚ä¾‹å¦‚å¤„ç† UsernamePasswordAuthenticationToken çš„ AuthenticationProvider æ˜¯ DaoAuthenticationProviderã€‚

### 1.2 AuthenticationManager

åœ¨ Spring Security ä¸­ï¼Œç”¨æ¥å¤„ç†èº«ä»½è®¤è¯çš„ç±»æ˜¯ AuthenticationManagerï¼Œæˆ‘ä»¬ä¹Ÿç§°ä¹‹ä¸ºè®¤è¯ç®¡ç†å™¨ã€‚

AuthenticationManager ä¸­è§„èŒƒäº† Spring Security çš„è¿‡æ»¤å™¨è¦å¦‚ä½•æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶åœ¨èº«ä»½è®¤è¯æˆåŠŸåè¿”å›ä¸€ä¸ªç»è¿‡è®¤è¯çš„ Authentication å¯¹è±¡ã€‚AuthenticationManager æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ƒçš„å®ç°ï¼Œä½†æ˜¯é€šå¸¸æˆ‘ä»¬ä½¿ç”¨æ›´å¤šçš„æ˜¯ç³»ç»Ÿæä¾›çš„ ProviderManagerã€‚

### 1.3 ProviderManager

ProviderManager æ˜¯çš„æœ€å¸¸ç”¨çš„ AuthenticationManager å®ç°ç±»ã€‚

ProviderManager ç®¡ç†äº†ä¸€ä¸ª AuthenticationProvider åˆ—è¡¨ï¼Œæ¯ä¸ª AuthenticationProvider éƒ½æ˜¯ä¸€ä¸ªè®¤è¯å™¨ï¼Œä¸åŒçš„ AuthenticationProvider ç”¨æ¥å¤„ç†ä¸åŒçš„ Authentication å¯¹è±¡çš„è®¤è¯ã€‚ä¸€æ¬¡å®Œæ•´çš„èº«ä»½è®¤è¯æµç¨‹å¯èƒ½ä¼šç»è¿‡å¤šä¸ª AuthenticationProviderã€‚

ProviderManager ç›¸å½“äºä»£ç†äº†å¤šä¸ª AuthenticationProviderï¼Œä»–ä»¬çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

![Image](img/640-1730174849006.webp)

### 1.4 AuthenticationProvider

AuthenticationProvider å®šä¹‰äº† Spring Security ä¸­çš„éªŒè¯é€»è¾‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ AuthenticationProvider çš„å®šä¹‰ï¼š

```
public interface AuthenticationProvider {
 Authentication authenticate(Authentication authentication)
   throws AuthenticationException;
 boolean supports(Class<?> authentication);
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒAuthenticationProvider ä¸­å°±ä¸¤ä¸ªæ–¹æ³•ï¼š

- authenticate æ–¹æ³•ç”¨æ¥åšéªŒè¯ï¼Œå°±æ˜¯éªŒè¯ç”¨æˆ·èº«ä»½ã€‚
- supports åˆ™ç”¨æ¥åˆ¤æ–­å½“å‰çš„ AuthenticationProvider æ˜¯å¦æ”¯æŒå¯¹åº”çš„ Authenticationã€‚

åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯ä¸­ï¼Œå¯èƒ½åŒ…å«å¤šä¸ª AuthenticationProviderï¼Œè€Œè¿™å¤šä¸ª AuthenticationProvider åˆ™ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒæ¾å“¥ä¹‹å‰çš„æ–‡ç« ï¼š[ğŸ‘‰æ¾å“¥æ‰‹æŠŠæ‰‹å¸¦ä½ æ‹ä¸€é Spring Security ç™»å½•æµç¨‹](https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247488026&idx=2&sn=3bd96d91e822abf753a8e91142e036be&scene=21#wechat_redirect)ã€‚

è¿™é‡Œæˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ DaoAuthenticationProviderï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€ä¸ªï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·å/å¯†ç ç™»å½•çš„æ—¶å€™ï¼Œç”¨çš„å°±æ˜¯å®ƒï¼ŒDaoAuthenticationProvider çš„çˆ¶ç±»æ˜¯ AbstractUserDetailsAuthenticationProviderï¼Œæˆ‘ä»¬å°±å…ˆä»å®ƒçš„çˆ¶ç±»çœ‹èµ·ï¼š

```
public abstract class AbstractUserDetailsAuthenticationProvider implements
  AuthenticationProvider, InitializingBean, MessageSourceAware {
 public Authentication authenticate(Authentication authentication)
   throws AuthenticationException {
  String username = (authentication.getPrincipal() == null) ? "NONE_PROVIDED"
    : authentication.getName();
  boolean cacheWasUsed = true;
  UserDetails user = this.userCache.getUserFromCache(username);
  if (user == null) {
   cacheWasUsed = false;
   try {
    user = retrieveUser(username,
      (UsernamePasswordAuthenticationToken) authentication);
   }
   catch (UsernameNotFoundException notFound) {
    logger.debug("User '" + username + "' not found");

    if (hideUserNotFoundExceptions) {
     throw new BadCredentialsException(messages.getMessage(
       "AbstractUserDetailsAuthenticationProvider.badCredentials",
       "Bad credentials"));
    }
    else {
     throw notFound;
    }
   }
  }

  try {
   preAuthenticationChecks.check(user);
   additionalAuthenticationChecks(user,
     (UsernamePasswordAuthenticationToken) authentication);
  }
  catch (AuthenticationException exception) {
   if (cacheWasUsed) {
    cacheWasUsed = false;
    user = retrieveUser(username,
      (UsernamePasswordAuthenticationToken) authentication);
    preAuthenticationChecks.check(user);
    additionalAuthenticationChecks(user,
      (UsernamePasswordAuthenticationToken) authentication);
   }
   else {
    throw exception;
   }
  }

  postAuthenticationChecks.check(user);

  if (!cacheWasUsed) {
   this.userCache.putUserInCache(user);
  }

  Object principalToReturn = user;

  if (forcePrincipalAsString) {
   principalToReturn = user.getUsername();
  }

  return createSuccessAuthentication(principalToReturn, authentication, user);
 }
 public boolean supports(Class<?> authentication) {
  return (UsernamePasswordAuthenticationToken.class
    .isAssignableFrom(authentication));
 }
}
```

AbstractUserDetailsAuthenticationProvider çš„ä»£ç è¿˜æ˜¯æŒºé•¿çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸¤ä¸ªæ–¹æ³•ï¼šauthenticate å’Œ supportsã€‚

authenticate æ–¹æ³•å°±æ˜¯ç”¨æ¥åšè®¤è¯çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸‹æ–¹æ³•æµç¨‹ï¼š

1. é¦–å…ˆä» Authentication æå–å‡ºç™»å½•ç”¨æˆ·åã€‚
2. ç„¶åé€šè¿‡æ‹¿ç€ username å»è°ƒç”¨ retrieveUser æ–¹æ³•å»è·å–å½“å‰ç”¨æˆ·å¯¹è±¡ï¼Œè¿™ä¸€æ­¥ä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå·±åœ¨ç™»å½•æ—¶å€™çš„å†™çš„ loadUserByUsername æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„ user å…¶å®å°±æ˜¯ä½ çš„ç™»å½•å¯¹è±¡ï¼Œå¯ä»¥å‚è€ƒå¾®äººäº‹çš„ org/javaboy/vhr/service/HrService.java#L34ï¼Œä¹Ÿå¯ä»¥å‚è€ƒæœ¬ç³»åˆ—ä¹‹å‰çš„æ–‡ç« ï¼š[ğŸ‘‰Spring Security+Spring Data Jpa å¼ºå¼ºè”æ‰‹ï¼Œå®‰å…¨ç®¡ç†åªæœ‰æ›´ç®€å•ï¼](https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247488229&idx=1&sn=2911c04bf19d41b00b4933d4044590f8&scene=21#wechat_redirect)ã€‚
3. æ¥ä¸‹æ¥è°ƒç”¨ preAuthenticationChecks.check æ–¹æ³•å»æ£€éªŒ user ä¸­çš„å„ä¸ªè´¦æˆ·çŠ¶æ€å±æ€§æ˜¯å¦æ­£å¸¸ï¼Œä¾‹å¦‚è´¦æˆ·æ˜¯å¦è¢«ç¦ç”¨ã€è´¦æˆ·æ˜¯å¦è¢«é”å®šã€è´¦æˆ·æ˜¯å¦è¿‡æœŸç­‰ç­‰ã€‚
4. additionalAuthenticationChecks æ–¹æ³•åˆ™æ˜¯åšå¯†ç æ¯”å¯¹çš„ï¼Œå¥½å¤šå°ä¼™ä¼´å¥½å¥‡ Spring Security çš„å¯†ç åŠ å¯†ä¹‹åï¼Œæ˜¯å¦‚ä½•è¿›è¡Œæ¯”è¾ƒçš„ï¼Œçœ‹è¿™é‡Œå°±æ‡‚äº†ï¼Œå› ä¸ºæ¯”è¾ƒçš„é€»è¾‘å¾ˆç®€å•ï¼Œæˆ‘è¿™é‡Œå°±ä¸è´´ä»£ç å‡ºæ¥äº†ã€‚ä½†æ˜¯æ³¨æ„ï¼ŒadditionalAuthenticationChecks æ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°æ˜¯åœ¨ AbstractUserDetailsAuthenticationProvider çš„å­ç±»ä¸­å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ DaoAuthenticationProviderã€‚è¿™ä¸ªå…¶å®å¾ˆå¥½ç†è§£ï¼Œå› ä¸º AbstractUserDetailsAuthenticationProvider ä½œä¸ºä¸€ä¸ªè¾ƒé€šç”¨çš„çˆ¶ç±»ï¼Œå¤„ç†ä¸€äº›é€šç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åœ¨ç™»å½•çš„æ—¶å€™ï¼Œæœ‰çš„ç™»å½•æ–¹å¼å¹¶ä¸éœ€è¦å¯†ç ï¼Œæ‰€ä»¥ additionalAuthenticationChecks æ–¹æ³•ä¸€èˆ¬äº¤ç»™å®ƒçš„å­ç±»å»å®ç°ï¼Œåœ¨ DaoAuthenticationProvider ç±»ä¸­ï¼ŒadditionalAuthenticationChecks æ–¹æ³•å°±æ˜¯åšå¯†ç æ¯”å¯¹çš„ï¼Œåœ¨å…¶ä»–çš„ AuthenticationProvider ä¸­ï¼ŒadditionalAuthenticationChecks æ–¹æ³•çš„ä½œç”¨å°±ä¸ä¸€å®šäº†ã€‚
5. æœ€ååœ¨ postAuthenticationChecks.check æ–¹æ³•ä¸­æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸã€‚
6. æ¥ä¸‹æ¥æœ‰ä¸€ä¸ª forcePrincipalAsString å±æ€§ï¼Œè¿™ä¸ªæ˜¯æ˜¯å¦å¼ºåˆ¶å°† Authentication ä¸­çš„ principal å±æ€§è®¾ç½®ä¸ºå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå±æ€§æˆ‘ä»¬ä¸€å¼€å§‹åœ¨ UsernamePasswordAuthenticationFilter ç±»ä¸­å…¶å®å°±æ˜¯è®¾ç½®ä¸ºå­—ç¬¦ä¸²çš„ï¼ˆå³ usernameï¼‰ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å°±å˜æˆå½“å‰ç”¨æˆ·è¿™ä¸ªå¯¹è±¡äº†ã€‚ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œå°±æ˜¯å› ä¸º forcePrincipalAsString é»˜è®¤ä¸º falseï¼Œä¸è¿‡è¿™å—å…¶å®ä¸ç”¨æ”¹ï¼Œå°±ç”¨ falseï¼Œè¿™æ ·åœ¨åæœŸè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™åè€Œæ–¹ä¾¿å¾ˆå¤šã€‚
7. æœ€åï¼Œé€šè¿‡ createSuccessAuthentication æ–¹æ³•æ„å»ºä¸€ä¸ªæ–°çš„ UsernamePasswordAuthenticationTokenã€‚

supports æ–¹æ³•å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¸»è¦ç”¨æ¥åˆ¤æ–­å½“å‰çš„ Authentication æ˜¯å¦æ˜¯ UsernamePasswordAuthenticationTokenã€‚

ç”±äº AbstractUserDetailsAuthenticationProvider å·²ç»æŠŠ authenticate å’Œ supports æ–¹æ³•å®ç°äº†ï¼Œæ‰€ä»¥åœ¨ DaoAuthenticationProvider ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ additionalAuthenticationChecks æ–¹æ³•å³å¯ï¼š

```
public class DaoAuthenticationProvider extends AbstractUserDetailsAuthenticationProvider {
 @SuppressWarnings("deprecation")
 protected void additionalAuthenticationChecks(UserDetails userDetails,
   UsernamePasswordAuthenticationToken authentication)
   throws AuthenticationException {
  if (authentication.getCredentials() == null) {
   throw new BadCredentialsException(messages.getMessage(
     "AbstractUserDetailsAuthenticationProvider.badCredentials",
     "Bad credentials"));
  }
  String presentedPassword = authentication.getCredentials().toString();
  if (!passwordEncoder.matches(presentedPassword, userDetails.getPassword())) {
   throw new BadCredentialsException(messages.getMessage(
     "AbstractUserDetailsAuthenticationProvider.badCredentials",
     "Bad credentials"));
  }
 }
}
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼ŒadditionalAuthenticationChecks æ–¹æ³•ä¸»è¦ç”¨æ¥åšå¯†ç æ¯”å¯¹çš„ï¼Œé€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ PasswordEncoder çš„ matches æ–¹æ³•åšæ¯”å¯¹ï¼Œå¦‚æœå¯†ç ä¸å¯¹åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å³å¯ã€‚

**æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”¨æˆ·å/å¯†ç ç™»å½•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™ä¸€æ­¥ã€‚**

è€Œ AuthenticationProvider éƒ½æ˜¯é€šè¿‡ ProviderManager#authenticate æ–¹æ³•æ¥è°ƒç”¨çš„ã€‚ç”±äºæˆ‘ä»¬çš„ä¸€æ¬¡è®¤è¯å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ª AuthenticationProviderï¼Œæ‰€ä»¥ï¼Œåœ¨ ProviderManager#authenticate æ–¹æ³•ä¸­ä¼šé€ä¸ªéå† AuthenticationProviderï¼Œå¹¶è°ƒç”¨ä»–ä»¬çš„ authenticate æ–¹æ³•åšè®¤è¯ï¼Œæˆ‘ä»¬æ¥ç¨å¾®ç…ä¸€çœ¼ ProviderManager#authenticate æ–¹æ³•ï¼š

```
public Authentication authenticate(Authentication authentication)
  throws AuthenticationException {
 for (AuthenticationProvider provider : getProviders()) {
  result = provider.authenticate(authentication);
  if (result != null) {
   copyDetails(authentication, result);
   break;
  }
 }
    ...
    ...
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¼šéå†æ‰€æœ‰çš„ AuthenticationProviderï¼Œå¹¶è°ƒç”¨å®ƒçš„ authenticate æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚

å¥½äº†ï¼Œå¤§è‡´çš„è®¤è¯æµç¨‹è¯´å®Œä¹‹åï¼Œç›¸ä¿¡å¤§å®¶å·²ç»æ˜ç™½äº†æˆ‘ä»¬è¦ä»å“ªé‡Œä¸‹æ‰‹äº†ã€‚

## 2.æ¡ˆä¾‹

è¦æƒ³æ¥å…¥å¤šä¸ªæ•°æ®æºï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›å¤šä¸ªè‡ªå®šä¹‰çš„ AuthenticationProviderï¼Œå¹¶äº¤ç»™ ProviderManager è¿›è¡Œç®¡ç†ï¼Œæ¯ä¸€ä¸ª AuthenticationProvider å¯¹åº”ä¸åŒçš„æ•°æ®æºå³å¯ã€‚

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Spring Boot é¡¹ç›®ï¼Œå¼•å…¥ security å’Œ web ä¾èµ–ï¼š

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

ç„¶ååˆ›å»ºä¸€ä¸ªæµ‹è¯• Controllerï¼Œå¦‚ä¸‹ï¼š

```
@RestController
public class HelloController {
    @GetMapping("/hello")
    public String hello() {
        return "hello";
    }
    @GetMapping("/admin")
    public String admin() {
        return "admin";
    }
}
```

æœ€åé…ç½® SecurityConfigï¼š

```
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Bean
    @Primary
    UserDetailsService us1() {
        return new InMemoryUserDetailsManager(User.builder().username("javaboy").password("{noop}123").roles("admin").build());
    }
    @Bean
    UserDetailsService us2() {
        return new InMemoryUserDetailsManager(User.builder().username("sang").password("{noop}123").roles("user").build());
    }
    @Override
    @Bean
    protected AuthenticationManager authenticationManager() throws Exception {
        DaoAuthenticationProvider dao1 = new DaoAuthenticationProvider();
        dao1.setUserDetailsService(us1());

        DaoAuthenticationProvider dao2 = new DaoAuthenticationProvider();
        dao2.setUserDetailsService(us2());

        ProviderManager manager = new ProviderManager(dao1, dao2);
        return manager;
    }
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers("/hello").hasRole("user")
                .antMatchers("/admin").hasRole("admin")
                .and()
                .formLogin()
                .loginProcessingUrl("/doLogin")
                .permitAll()
                .and()
                .csrf().disable();
    }
}
```

1. é¦–å…ˆæä¾›ä¸¤ä¸ª UserDetailsService å®ä¾‹ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘é‡‡ç”¨ InMemoryUserDetailsManager æ¥æ„å»º UserDetailsServiceï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¤§å®¶è‡ªè¡Œå®šä¹‰ UserDetailsService å³å¯ï¼Œå¯ä»¥å‚è€ƒï¼ˆ[ğŸ‘‰Spring Security+Spring Data Jpa å¼ºå¼ºè”æ‰‹ï¼Œå®‰å…¨ç®¡ç†åªæœ‰æ›´ç®€å•ï¼](https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247488229&idx=1&sn=2911c04bf19d41b00b4933d4044590f8&scene=21#wechat_redirect)ï¼‰ä¸€æ–‡ã€‚
2. æ¥ä¸‹æ¥è‡ªå®šä¹‰ AuthenticationManagerï¼ŒAuthenticationManager çš„å®ä¾‹å®é™…ä¸Šå°±æ˜¯ ProviderManagerã€‚å…ˆæ„é€ ä¸¤ä¸ª DaoAuthenticationProvider å®ä¾‹ï¼Œæ¯ä¸€ä¸ªä¼ å…¥ä¸åŒçš„ UserDetailsService å®ä¾‹ï¼Œç›¸å½“äºæ¯ä¸€ä¸ª DaoAuthenticationProvider ä»£è¡¨äº†ä¸€ä¸ª UserDetailsService å®ä¾‹ã€‚
3. æœ€åé…ç½® HttpSecurityï¼Œè¿™ä¸ªæœ¬ç³»åˆ—å‰é¢æ–‡ç« è®²è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

**æ ¹æ®ç¬¬ä¸€å°èŠ‚ä¸­çš„åŸç†ï¼Œåœ¨ç”¨æˆ·èº«ä»½è®¤è¯æ—¶ï¼Œä¸¤ä¸ª DaoAuthenticationProvider ä¼šè¢«ä¾æ¬¡æ‰§è¡Œï¼Œè¿™æ ·æˆ‘ä»¬é…ç½®çš„ä¸¤ä¸ªæ•°æ®æºå°±ç”Ÿæ•ˆäº†ã€‚**

é…ç½®å®Œæˆåï¼Œå¯åŠ¨é¡¹ç›®ã€‚

åœ¨ postman ä¸­è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ javaboy ç™»å½•ï¼Œç™»å½•æˆåŠŸåçš„ç”¨æˆ·å…·å¤‡ admin è§’è‰²ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—® http://localhost:8080/adminï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ sang ç™»å½•ï¼Œç™»å½•åçš„ç”¨æˆ·å…·å¤‡ user è§’è‰²ï¼Œå¯ä»¥è®¿é—® http://localhost:8080/helloã€‚

## 3.å°ç»“

å¥½å•¦ï¼Œæœ¬æ–‡å’Œå°ä¼™ä¼´ä»¬åˆ†äº«äº†ä¸€ä¸‹ Spring Security ä¸­å¦‚ä½•åŒæ—¶æ¥å…¥å¤šä¸ªæ•°æ®æºçš„é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å°è¯•ä¸€ä¸‹å“¦ï½

å¾®ä¿¡å…¬ä¼—å·ã€æ±Ÿå—ä¸€ç‚¹é›¨ã€‘åå°å›å¤ **multiusers** å¯ä»¥è·å–æœ¬æ–‡æ¡ˆä¾‹ä¸‹è½½åœ°å€å“¦ï½

**å¦‚æœå°ä¼™ä¼´ä»¬è§‰å¾—æœ‰æ”¶è·ï¼Œè®°å¾—ç‚¹ä¸ªåœ¨çœ‹é¼“åŠ±ä¸‹æ¾å“¥å“¦ï½**

ä»Šæ—¥å¹²è´§

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

åˆšåˆšå‘è¡¨

æŸ¥çœ‹:66666å›å¤:666

å…¬ä¼—å·åå°å›å¤ ssmï¼Œå…è´¹è·å–æ¾å“¥çº¯æ‰‹æ•²çš„ SSM æ¡†æ¶å­¦ä¹ å¹²è´§ã€‚

SpringSecurityç³»åˆ—52

SpringSecurityç³»åˆ— Â· ç›®å½•







ä¸Šä¸€ç¯‡Spring Security ç«Ÿç„¶å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Ÿä¸‹ä¸€ç¯‡æ·±å…¥ç†è§£ FilterChainProxyã€æºç ç¯‡ã€‘









# 



























Scan to Follow