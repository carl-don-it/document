åŠ å¾®ä¿¡heibaifkï¼Œç½‘ç›˜åœæ­¢æ›´æ–°

# 20è®²å¹»è¯»æ˜¯ä»€ä¹ˆï¼Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜

![img](https://static001.geekbang.org/resource/image/97/b7/9719ecdc5d6f443817438205259f8bb7.jpg)

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ€åï¼Œæˆ‘ç»™ä½ ç•™äº†ä¸€ä¸ªå…³äºåŠ é”è§„åˆ™çš„é—®é¢˜ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»è¿™ä¸ªé—®é¢˜è¯´èµ·å§ã€‚

ä¸ºäº†ä¾¿äºè¯´æ˜é—®é¢˜ï¼Œè¿™ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±å…ˆä½¿ç”¨ä¸€ä¸ªå°ä¸€ç‚¹å„¿çš„è¡¨ã€‚å»ºè¡¨å’Œåˆå§‹åŒ–è¯­å¥å¦‚ä¸‹ï¼ˆä¸ºäº†ä¾¿äºæœ¬æœŸçš„ä¾‹å­è¯´æ˜ï¼Œæˆ‘æŠŠä¸Šç¯‡æ–‡ç« ä¸­ç”¨åˆ°çš„è¡¨ç»“æ„åšäº†ç‚¹å„¿ä¿®æ”¹ï¼‰ï¼š

```mysql
CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
) ENGINE=InnoDB;

insert into t values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```

è¿™ä¸ªè¡¨é™¤äº†ä¸»é”®idå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç´¢å¼•cï¼Œåˆå§‹åŒ–è¯­å¥åœ¨è¡¨ä¸­æ’å…¥äº†6è¡Œæ•°æ®ã€‚

ä¸ŠæœŸæˆ‘ç•™ç»™ä½ çš„é—®é¢˜æ˜¯ï¼Œä¸‹é¢çš„è¯­å¥åºåˆ—ï¼Œæ˜¯æ€ä¹ˆåŠ é”çš„ï¼ŒåŠ çš„é”åˆæ˜¯ä»€ä¹ˆæ—¶å€™é‡Šæ”¾çš„å‘¢ï¼Ÿ

```mysql
begin;
select * from t where d=5 for update;
commit;
```

æ¯”è¾ƒå¥½ç†è§£çš„æ˜¯ï¼Œè¿™ä¸ªè¯­å¥ä¼šå‘½ä¸­d=5çš„è¿™ä¸€è¡Œï¼Œå¯¹åº”çš„ä¸»é”®id=5ï¼Œå› æ­¤åœ¨select è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œid=5è¿™ä¸€è¡Œä¼šåŠ ä¸€ä¸ªå†™é”ï¼Œè€Œä¸”ç”±äºä¸¤é˜¶æ®µé”åè®®ï¼Œè¿™ä¸ªå†™é”ä¼šåœ¨æ‰§è¡Œcommitè¯­å¥çš„æ—¶å€™é‡Šæ”¾ã€‚

ç”±äºå­—æ®µdä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œå› æ­¤è¿™æ¡æŸ¥è¯¢è¯­å¥ä¼šåšå…¨è¡¨æ‰«æã€‚é‚£ä¹ˆï¼Œå…¶ä»–è¢«æ‰«æåˆ°çš„ï¼Œä½†æ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„5è¡Œè®°å½•ä¸Šï¼Œä¼šä¸ä¼šè¢«åŠ é”å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ï¼ŒInnoDBçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œæ‰€ä»¥æœ¬æ–‡æ¥ä¸‹æ¥æ²¡æœ‰ç‰¹æ®Šè¯´æ˜çš„éƒ¨åˆ†ï¼Œéƒ½æ˜¯è®¾å®šåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ã€‚

# å¹»è¯»æ˜¯ä»€ä¹ˆï¼Ÿ

ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ï¼Œå¦‚æœåªåœ¨id=5è¿™ä¸€è¡ŒåŠ é”ï¼Œè€Œå…¶ä»–è¡Œçš„ä¸åŠ é”çš„è¯ï¼Œä¼šæ€ä¹ˆæ ·ã€‚

ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼š

![img](https://static001.geekbang.org/resource/image/5b/8b/5bc506e5884d21844126d26bbe6fa68b.png)

å›¾ 1 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”

å¯ä»¥çœ‹åˆ°ï¼Œsession Aé‡Œæ‰§è¡Œäº†ä¸‰æ¬¡æŸ¥è¯¢ï¼Œåˆ†åˆ«æ˜¯Q1ã€Q2å’ŒQ3ã€‚å®ƒä»¬çš„SQLè¯­å¥ç›¸åŒï¼Œéƒ½æ˜¯select * from t where d=5 for updateã€‚è¿™ä¸ªè¯­å¥çš„æ„æ€ä½ åº”è¯¥å¾ˆæ¸…æ¥šäº†ï¼ŒæŸ¥æ‰€æœ‰d=5çš„è¡Œï¼Œè€Œä¸”ä½¿ç”¨çš„æ˜¯å½“å‰è¯»ï¼Œå¹¶ä¸”åŠ ä¸Šå†™é”ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸‰æ¡SQLè¯­å¥ï¼Œåˆ†åˆ«ä¼šè¿”å›ä»€ä¹ˆç»“æœã€‚

1. Q1åªè¿”å›id=5è¿™ä¸€è¡Œï¼›
2. åœ¨T2æ—¶åˆ»ï¼Œsession BæŠŠid=0è¿™ä¸€è¡Œçš„då€¼æ”¹æˆäº†5ï¼Œå› æ­¤T3æ—¶åˆ»Q2æŸ¥å‡ºæ¥çš„æ˜¯id=0å’Œid=5è¿™ä¸¤è¡Œï¼›
3. åœ¨T4æ—¶åˆ»ï¼Œsession Cåˆæ’å…¥ä¸€è¡Œï¼ˆ1,1,5ï¼‰ï¼Œå› æ­¤T5æ—¶åˆ»Q3æŸ¥å‡ºæ¥çš„æ˜¯id=0ã€id=1å’Œid=5çš„è¿™ä¸‰è¡Œã€‚

å…¶ä¸­ï¼ŒQ3è¯»åˆ°id=1è¿™ä¸€è¡Œçš„ç°è±¡ï¼Œè¢«ç§°ä¸ºâ€œå¹»è¯»â€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹»è¯»æŒ‡çš„æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨å‰åä¸¤æ¬¡æŸ¥è¯¢åŒä¸€ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåä¸€æ¬¡æŸ¥è¯¢çœ‹åˆ°äº†å‰ä¸€æ¬¡æŸ¥è¯¢æ²¡æœ‰çœ‹åˆ°çš„è¡Œã€‚

è¿™é‡Œï¼Œæˆ‘éœ€è¦å¯¹â€œå¹»è¯»â€åšä¸€ä¸ªè¯´æ˜ï¼š

1. åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ™®é€šçš„æŸ¥è¯¢æ˜¯å¿«ç…§è¯»ï¼Œæ˜¯ä¸ä¼šçœ‹åˆ°åˆ«çš„äº‹åŠ¡æ’å…¥çš„æ•°æ®çš„ã€‚å› æ­¤ï¼Œå¹»è¯»åœ¨â€œå½“å‰è¯»â€ä¸‹æ‰ä¼šå‡ºç°ã€‚
2. ä¸Šé¢session Bçš„ä¿®æ”¹ç»“æœï¼Œè¢«session Aä¹‹åçš„selectè¯­å¥ç”¨â€œå½“å‰è¯»â€çœ‹åˆ°ï¼Œä¸èƒ½ç§°ä¸ºå¹»è¯»ã€‚å¹»è¯»ä»…ä¸“æŒ‡â€œæ–°æ’å…¥çš„è¡Œâ€ã€‚

å¦‚æœåªä»ç¬¬8ç¯‡æ–‡ç« [ã€Šäº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„ï¼Ÿã€‹](https://time.geekbang.org/column/article/70562)æˆ‘ä»¬å­¦åˆ°çš„äº‹åŠ¡å¯è§æ€§è§„åˆ™æ¥åˆ†æçš„è¯ï¼Œä¸Šé¢è¿™ä¸‰æ¡SQLè¯­å¥çš„è¿”å›ç»“æœéƒ½æ²¡æœ‰é—®é¢˜ã€‚

å› ä¸ºè¿™ä¸‰ä¸ªæŸ¥è¯¢éƒ½æ˜¯åŠ äº†for updateï¼Œéƒ½æ˜¯å½“å‰è¯»ã€‚è€Œå½“å‰è¯»çš„è§„åˆ™ï¼Œå°±æ˜¯è¦èƒ½è¯»åˆ°æ‰€æœ‰å·²ç»æäº¤çš„è®°å½•çš„æœ€æ–°å€¼ã€‚å¹¶ä¸”ï¼Œsession Bå’ŒsessionCçš„ä¸¤æ¡è¯­å¥ï¼Œæ‰§è¡Œåå°±ä¼šæäº¤ï¼Œæ‰€ä»¥Q2å’ŒQ3å°±æ˜¯åº”è¯¥çœ‹åˆ°è¿™ä¸¤ä¸ªäº‹åŠ¡çš„æ“ä½œæ•ˆæœï¼Œè€Œä¸”ä¹Ÿçœ‹åˆ°äº†ï¼Œè¿™è·Ÿäº‹åŠ¡çš„å¯è§æ€§è§„åˆ™å¹¶ä¸çŸ›ç›¾ã€‚

ä½†æ˜¯ï¼Œè¿™æ˜¯ä¸æ˜¯çœŸçš„æ²¡é—®é¢˜å‘¢ï¼Ÿ

ä¸ï¼Œè¿™é‡Œè¿˜çœŸå°±æœ‰é—®é¢˜ã€‚

# å¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**é¦–å…ˆæ˜¯è¯­ä¹‰ä¸Šçš„ã€‚**session Aåœ¨T1æ—¶åˆ»å°±å£°æ˜äº†ï¼Œâ€œæˆ‘è¦æŠŠæ‰€æœ‰d=5çš„è¡Œé”ä½ï¼Œä¸å‡†åˆ«çš„äº‹åŠ¡è¿›è¡Œè¯»å†™æ“ä½œâ€ã€‚è€Œå®é™…ä¸Šï¼Œè¿™ä¸ªè¯­ä¹‰è¢«ç ´åäº†ã€‚

å¦‚æœç°åœ¨è¿™æ ·çœ‹æ„Ÿè§‰è¿˜ä¸æ˜æ˜¾çš„è¯ï¼Œæˆ‘å†å¾€session Bå’Œsession Cé‡Œé¢åˆ†åˆ«åŠ ä¸€æ¡SQLè¯­å¥ï¼Œä½ å†çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆç°è±¡ã€‚

![img](https://static001.geekbang.org/resource/image/7a/07/7a9ffa90ac3cc78db6a51ff9b9075607.png)

å›¾ 2 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”--è¯­ä¹‰è¢«ç ´å

session Bçš„ç¬¬äºŒæ¡è¯­å¥update t set c=5 where id=0ï¼Œè¯­ä¹‰æ˜¯â€œæˆ‘æŠŠid=0ã€d=5è¿™ä¸€è¡Œçš„cå€¼ï¼Œæ”¹æˆäº†5â€ã€‚

ç”±äºåœ¨T1æ—¶åˆ»ï¼Œsession A è¿˜åªæ˜¯ç»™id=5è¿™ä¸€è¡ŒåŠ äº†è¡Œé”ï¼Œ å¹¶æ²¡æœ‰ç»™id=0è¿™è¡ŒåŠ ä¸Šé”ã€‚å› æ­¤ï¼Œsession Båœ¨T2æ—¶åˆ»ï¼Œæ˜¯å¯ä»¥æ‰§è¡Œè¿™ä¸¤æ¡updateè¯­å¥çš„ã€‚è¿™æ ·ï¼Œå°±ç ´åäº† session A é‡ŒQ1è¯­å¥è¦é”ä½æ‰€æœ‰d=5çš„è¡Œçš„åŠ é”å£°æ˜ã€‚

session Cä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå¯¹id=1è¿™ä¸€è¡Œçš„ä¿®æ”¹ï¼Œä¹Ÿæ˜¯ç ´åäº†Q1çš„åŠ é”å£°æ˜ã€‚

**å…¶æ¬¡ï¼Œæ˜¯æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚**

æˆ‘ä»¬çŸ¥é“ï¼Œé”çš„è®¾è®¡æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è€Œè¿™ä¸ªä¸€è‡´æ€§ï¼Œä¸æ­¢æ˜¯æ•°æ®åº“å†…éƒ¨æ•°æ®çŠ¶æ€åœ¨æ­¤åˆ»çš„ä¸€è‡´æ€§ï¼Œè¿˜åŒ…å«äº†æ•°æ®å’Œæ—¥å¿—åœ¨é€»è¾‘ä¸Šçš„ä¸€è‡´æ€§ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ç»™session Aåœ¨T1æ—¶åˆ»å†åŠ ä¸€ä¸ªæ›´æ–°è¯­å¥ï¼Œå³ï¼šupdate t set d=100 where d=5ã€‚

![img](https://static001.geekbang.org/resource/image/dc/92/dcea7845ff0bdbee2622bf3c67d31d92.png)

å›¾ 3 å‡è®¾åªåœ¨id=5è¿™ä¸€è¡ŒåŠ è¡Œé”--æ•°æ®ä¸€è‡´æ€§é—®é¢˜

updateçš„åŠ é”è¯­ä¹‰å’Œselect ...for update æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™åŠ ä¸Šè¿™æ¡updateè¯­å¥ä¹Ÿå¾ˆåˆç†ã€‚session Aå£°æ˜è¯´â€œè¦ç»™d=5çš„è¯­å¥åŠ ä¸Šé”â€ï¼Œå°±æ˜¯ä¸ºäº†è¦æ›´æ–°æ•°æ®ï¼Œæ–°åŠ çš„è¿™æ¡updateè¯­å¥å°±æ˜¯æŠŠå®ƒè®¤ä¸ºåŠ ä¸Šäº†é”çš„è¿™ä¸€è¡Œçš„då€¼ä¿®æ”¹æˆäº†100ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å›¾3æ‰§è¡Œå®Œæˆåï¼Œæ•°æ®åº“é‡Œä¼šæ˜¯ä»€ä¹ˆç»“æœã€‚

1. ç»è¿‡T1æ—¶åˆ»ï¼Œid=5è¿™ä¸€è¡Œå˜æˆ (5,5,100)ï¼Œå½“ç„¶è¿™ä¸ªç»“æœæœ€ç»ˆæ˜¯åœ¨T6æ—¶åˆ»æ­£å¼æäº¤çš„;
2. ç»è¿‡T2æ—¶åˆ»ï¼Œid=0è¿™ä¸€è¡Œå˜æˆ(0,5,5);
3. ç»è¿‡T4æ—¶åˆ»ï¼Œè¡¨é‡Œé¢å¤šäº†ä¸€è¡Œ(1,5,5);
4. å…¶ä»–è¡Œè·Ÿè¿™ä¸ªæ‰§è¡Œåºåˆ—æ— å…³ï¼Œä¿æŒä¸å˜ã€‚

è¿™æ ·çœ‹ï¼Œè¿™äº›æ•°æ®ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ—¶å€™binlogé‡Œé¢çš„å†…å®¹ã€‚

1. T2æ—¶åˆ»ï¼Œsession Bäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›
2. T4æ—¶åˆ»ï¼Œsession Cäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†ä¸¤æ¡è¯­å¥ï¼›
3. T6æ—¶åˆ»ï¼Œsession Aäº‹åŠ¡æäº¤ï¼Œå†™å…¥äº†update t set d=100 where d=5 è¿™æ¡è¯­å¥ã€‚

æˆ‘ç»Ÿä¸€æ”¾åˆ°ä¸€èµ·çš„è¯ï¼Œå°±æ˜¯è¿™æ ·çš„ï¼š

```
update t set d=5 where id=0; /*(0,0,5)*/
update t set c=5 where id=0; /*(0,5,5)*/

insert into t values(1,1,5); /*(1,1,5)*/
update t set c=5 where id=1; /*(1,5,5)*/

update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/
```

å¥½ï¼Œä½ åº”è¯¥çœ‹å‡ºé—®é¢˜äº†ã€‚è¿™ä¸ªè¯­å¥åºåˆ—ï¼Œä¸è®ºæ˜¯æ‹¿åˆ°å¤‡åº“å»æ‰§è¡Œï¼Œè¿˜æ˜¯ä»¥åç”¨binlogæ¥å…‹éš†ä¸€ä¸ªåº“ï¼Œè¿™ä¸‰è¡Œçš„ç»“æœï¼Œéƒ½å˜æˆäº† (0,5,100)ã€(1,5,100)å’Œ(5,5,100)ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œid=0å’Œid=1è¿™ä¸¤è¡Œï¼Œå‘ç”Ÿäº†æ•°æ®ä¸ä¸€è‡´ã€‚è¿™ä¸ªé—®é¢˜å¾ˆä¸¥é‡ï¼Œæ˜¯ä¸è¡Œçš„ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ï¼Œ**è¿™ä¸ªæ•°æ®ä¸ä¸€è‡´åˆ°åº•æ˜¯æ€ä¹ˆå¼•å…¥çš„ï¼Ÿ**

æˆ‘ä»¬åˆ†æä¸€ä¸‹å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯æˆ‘ä»¬å‡è®¾â€œselect * from t where d=5 for updateè¿™æ¡è¯­å¥åªç»™d=5è¿™ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯id=5çš„è¿™ä¸€è¡ŒåŠ é”â€å¯¼è‡´çš„ã€‚

æ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºï¼Œä¸Šé¢çš„è®¾å®šä¸åˆç†ï¼Œè¦æ”¹ã€‚

é‚£æ€ä¹ˆæ”¹å‘¢ï¼Ÿæˆ‘ä»¬æŠŠæ‰«æè¿‡ç¨‹ä¸­ç¢°åˆ°çš„è¡Œï¼Œä¹Ÿéƒ½åŠ ä¸Šå†™é”ï¼Œå†æ¥çœ‹çœ‹æ‰§è¡Œæ•ˆæœã€‚

![img](https://static001.geekbang.org/resource/image/34/47/34ad6478281709da833856084a1e3447.png)

å›¾ 4 å‡è®¾æ‰«æåˆ°çš„è¡Œéƒ½è¢«åŠ ä¸Šäº†è¡Œé”

ç”±äºsession AæŠŠæ‰€æœ‰çš„è¡Œéƒ½åŠ äº†å†™é”ï¼Œæ‰€ä»¥session Båœ¨æ‰§è¡Œç¬¬ä¸€ä¸ªupdateè¯­å¥çš„æ—¶å€™å°±è¢«é”ä½äº†ã€‚éœ€è¦ç­‰åˆ°T6æ—¶åˆ»session Aæäº¤ä»¥åï¼Œsession Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

è¿™æ ·å¯¹äºid=0è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œçš„æœ€ç»ˆç»“æœè¿˜æ˜¯ (0,5,5)ã€‚åœ¨binlogé‡Œé¢ï¼Œæ‰§è¡Œåºåˆ—æ˜¯è¿™æ ·çš„ï¼š

```
insert into t values(1,1,5); /*(1,1,5)*/
update t set c=5 where id=1; /*(1,5,5)*/

update t set d=100 where d=5;/*æ‰€æœ‰d=5çš„è¡Œï¼Œdæ”¹æˆ100*/

update t set d=5 where id=0; /*(0,0,5)*/
update t set c=5 where id=0; /*(0,5,5)*/
```

å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‰ç…§æ—¥å¿—é¡ºåºæ‰§è¡Œï¼Œid=0è¿™ä¸€è¡Œçš„æœ€ç»ˆç»“æœä¹Ÿæ˜¯(0,5,5)ã€‚æ‰€ä»¥ï¼Œid=0è¿™ä¸€è¡Œçš„é—®é¢˜è§£å†³äº†ã€‚

ä½†åŒæ—¶ä½ ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œid=1è¿™ä¸€è¡Œï¼Œåœ¨æ•°æ®åº“é‡Œé¢çš„ç»“æœæ˜¯(1,5,5)ï¼Œè€Œæ ¹æ®binlogçš„æ‰§è¡Œç»“æœæ˜¯(1,5,100)ï¼Œä¹Ÿå°±æ˜¯è¯´å¹»è¯»çš„é—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å·²ç»è¿™ä¹ˆâ€œå‡¶æ®‹â€åœ°ï¼ŒæŠŠæ‰€æœ‰çš„è®°å½•éƒ½ä¸Šäº†é”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†id=1è¿™ä¸€è¡Œçš„æ’å…¥å’Œæ›´æ–°å‘¢ï¼Ÿ

åŸå› å¾ˆç®€å•ã€‚åœ¨T3æ—¶åˆ»ï¼Œæˆ‘ä»¬ç»™æ‰€æœ‰è¡ŒåŠ é”çš„æ—¶å€™ï¼Œid=1è¿™ä¸€è¡Œè¿˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨ä¹Ÿå°±åŠ ä¸ä¸Šé”ã€‚

**ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿æŠŠæ‰€æœ‰çš„è®°å½•éƒ½åŠ ä¸Šé”ï¼Œè¿˜æ˜¯é˜»æ­¢ä¸äº†æ–°æ’å…¥çš„è®°å½•ï¼Œ**è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆâ€œå¹»è¯»â€ä¼šè¢«å•ç‹¬æ‹¿å‡ºæ¥è§£å†³çš„åŸå› ã€‚

åˆ°è¿™é‡Œï¼Œå…¶å®æˆ‘ä»¬åˆšè¯´æ˜å®Œæ–‡ç« çš„æ ‡é¢˜ ï¼šå¹»è¯»çš„å®šä¹‰å’Œå¹»è¯»æœ‰ä»€ä¹ˆé—®é¢˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†çœ‹çœ‹InnoDBæ€ä¹ˆè§£å†³å¹»è¯»çš„é—®é¢˜ã€‚

# å¦‚ä½•è§£å†³å¹»è¯»ï¼Ÿ

ç°åœ¨ä½ çŸ¥é“äº†ï¼Œäº§ç”Ÿå¹»è¯»çš„åŸå› æ˜¯ï¼Œè¡Œé”åªèƒ½é”ä½è¡Œï¼Œä½†æ˜¯æ–°æ’å…¥è®°å½•è¿™ä¸ªåŠ¨ä½œï¼Œè¦æ›´æ–°çš„æ˜¯è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ã€‚å› æ­¤ï¼Œä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼ŒInnoDBåªå¥½å¼•å…¥æ–°çš„é”ï¼Œä¹Ÿå°±æ˜¯é—´éš™é”(Gap Lock)ã€‚

é¡¾åæ€ä¹‰ï¼Œé—´éš™é”ï¼Œé”çš„å°±æ˜¯ä¸¤ä¸ªå€¼ä¹‹é—´çš„ç©ºéš™ã€‚æ¯”å¦‚æ–‡ç« å¼€å¤´çš„è¡¨tï¼Œåˆå§‹åŒ–æ’å…¥äº†6ä¸ªè®°å½•ï¼Œè¿™å°±äº§ç”Ÿäº†7ä¸ªé—´éš™ã€‚

![img](https://static001.geekbang.org/resource/image/e7/61/e7f7ca0d3dab2f48c588d714ee3ac861.png)

å›¾ 5 è¡¨tä¸»é”®ç´¢å¼•ä¸Šçš„è¡Œé”å’Œé—´éš™é”

è¿™æ ·ï¼Œå½“ä½ æ‰§è¡Œ select * from t where d=5 for updateçš„æ—¶å€™ï¼Œå°±ä¸æ­¢æ˜¯ç»™æ•°æ®åº“ä¸­å·²æœ‰çš„6ä¸ªè®°å½•åŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜åŒæ—¶åŠ äº†7ä¸ªé—´éš™é”ã€‚è¿™æ ·å°±ç¡®ä¿äº†æ— æ³•å†æ’å…¥æ–°çš„è®°å½•ã€‚

ä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™ï¼Œåœ¨ä¸€è¡Œè¡Œæ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…å°†ç»™è¡ŒåŠ ä¸Šäº†è¡Œé”ï¼Œè¿˜ç»™è¡Œä¸¤è¾¹çš„ç©ºéš™ï¼Œä¹ŸåŠ ä¸Šäº†é—´éš™é”ã€‚

ç°åœ¨ä½ çŸ¥é“äº†ï¼Œæ•°æ®è¡Œæ˜¯å¯ä»¥åŠ ä¸Šé”çš„å®ä½“ï¼Œæ•°æ®è¡Œä¹‹é—´çš„é—´éš™ï¼Œä¹Ÿæ˜¯å¯ä»¥åŠ ä¸Šé”çš„å®ä½“ã€‚ä½†æ˜¯é—´éš™é”è·Ÿæˆ‘ä»¬ä¹‹å‰ç¢°åˆ°è¿‡çš„é”éƒ½ä¸å¤ªä¸€æ ·ã€‚

æ¯”å¦‚è¡Œé”ï¼Œåˆ†æˆè¯»é”å’Œå†™é”ã€‚ä¸‹å›¾å°±æ˜¯è¿™ä¸¤ç§ç±»å‹è¡Œé”çš„å†²çªå…³ç³»ã€‚

![img](https://static001.geekbang.org/resource/image/c4/51/c435c765556c0f3735a6eda0779ff151.png)

å›¾6 ä¸¤ç§è¡Œé”é—´çš„å†²çªå…³ç³»

ä¹Ÿå°±æ˜¯è¯´ï¼Œè·Ÿè¡Œé”æœ‰å†²çªå…³ç³»çš„æ˜¯â€œå¦å¤–ä¸€ä¸ªè¡Œé”â€ã€‚

ä½†æ˜¯é—´éš™é”ä¸ä¸€æ ·ï¼Œ**è·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œã€‚**é—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»ã€‚

è¿™å¥è¯ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘ç»™ä½ ä¸¾ä¸ªä¾‹å­ï¼š

![img](https://static001.geekbang.org/resource/image/7c/98/7c37732d936650f1cda7dbf27daf7498.png)

å›¾7 é—´éš™é”ä¹‹é—´ä¸äº’é”

è¿™é‡Œsession Bå¹¶ä¸ä¼šè¢«å µä½ã€‚å› ä¸ºè¡¨té‡Œå¹¶æ²¡æœ‰c=7è¿™ä¸ªè®°å½•ï¼Œå› æ­¤session AåŠ çš„æ˜¯é—´éš™é”(5,10)ã€‚è€Œsession Bä¹Ÿæ˜¯åœ¨è¿™ä¸ªé—´éš™åŠ çš„é—´éš™é”ã€‚å®ƒä»¬æœ‰å…±åŒçš„ç›®æ ‡ï¼Œå³ï¼šä¿æŠ¤è¿™ä¸ªé—´éš™ï¼Œä¸å…è®¸æ’å…¥å€¼ã€‚ä½†ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä¸å†²çªçš„ã€‚

é—´éš™é”å’Œè¡Œé”åˆç§°next-key lockï¼Œæ¯ä¸ªnext-key lockæ˜¯å‰å¼€åé—­åŒºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„è¡¨tåˆå§‹åŒ–ä»¥åï¼Œå¦‚æœç”¨select * from t for updateè¦æŠŠæ•´ä¸ªè¡¨æ‰€æœ‰è®°å½•é”èµ·æ¥ï¼Œå°±å½¢æˆäº†7ä¸ªnext-key lockï¼Œåˆ†åˆ«æ˜¯ (-âˆ,0]ã€(0,5]ã€(5,10]ã€(10,15]ã€(15,20]ã€(20, 25]ã€(25, +suprenum]ã€‚

> å¤‡æ³¨ï¼šè¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œæˆ‘ä»¬æŠŠé—´éš™é”è®°ä¸ºå¼€åŒºé—´ï¼ŒæŠŠnext-key lockè®°ä¸ºå‰å¼€åé—­åŒºé—´ã€‚

ä½ å¯èƒ½ä¼šé—®è¯´ï¼Œè¿™ä¸ªsuprenumä»å“ªå„¿æ¥çš„å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸º+âˆæ˜¯å¼€åŒºé—´ã€‚å®ç°ä¸Šï¼ŒInnoDBç»™æ¯ä¸ªç´¢å¼•åŠ äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æœ€å¤§å€¼suprenumï¼Œè¿™æ ·æ‰ç¬¦åˆæˆ‘ä»¬å‰é¢è¯´çš„â€œéƒ½æ˜¯å‰å¼€åé—­åŒºé—´â€ã€‚

**é—´éš™é”å’Œnext-key lockçš„å¼•å…¥ï¼Œå¸®æˆ‘ä»¬è§£å†³äº†å¹»è¯»çš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€äº›â€œå›°æ‰°â€ã€‚**

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œå°±æœ‰åŒå­¦æåˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘æŠŠä»–çš„é—®é¢˜è½¬è¿°ä¸€ä¸‹ï¼Œå¯¹åº”åˆ°æˆ‘ä»¬è¿™ä¸ªä¾‹å­çš„è¡¨æ¥è¯´ï¼Œä¸šåŠ¡é€»è¾‘è¿™æ ·çš„ï¼šä»»æ„é”ä½ä¸€è¡Œï¼Œå¦‚æœè¿™ä¸€è¡Œä¸å­˜åœ¨çš„è¯å°±æ’å…¥ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸€è¡Œå°±æ›´æ–°å®ƒçš„æ•°æ®ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
begin;
select * from t where id=N for update;

/*å¦‚æœè¡Œä¸å­˜åœ¨*/
insert into t values(N,N,N);
/*å¦‚æœè¡Œå­˜åœ¨*/
update t set d=N set id=N;

commit;
```

å¯èƒ½ä½ ä¼šè¯´ï¼Œè¿™ä¸ªä¸æ˜¯insert ... on duplicate key update å°±èƒ½è§£å†³å—ï¼Ÿä½†å…¶å®åœ¨æœ‰å¤šä¸ªå”¯ä¸€é”®çš„æ—¶å€™ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸èƒ½æ»¡è¶³è¿™ä½æé—®åŒå­¦çš„éœ€æ±‚çš„ã€‚è‡³äºä¸ºä»€ä¹ˆï¼Œæˆ‘ä¼šåœ¨åé¢çš„æ–‡ç« ä¸­å†å±•å¼€è¯´æ˜ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°±åªè®¨è®ºè¿™ä¸ªé€»è¾‘ã€‚

è¿™ä¸ªåŒå­¦ç¢°åˆ°çš„ç°è±¡æ˜¯ï¼Œè¿™ä¸ªé€»è¾‘ä¸€æ—¦æœ‰å¹¶å‘ï¼Œå°±ä¼šç¢°åˆ°æ­»é”ã€‚ä½ ä¸€å®šä¹Ÿè§‰å¾—å¥‡æ€ªï¼Œè¿™ä¸ªé€»è¾‘æ¯æ¬¡æ“ä½œå‰ç”¨for updateé”èµ·æ¥ï¼Œå·²ç»æ˜¯æœ€ä¸¥æ ¼çš„æ¨¡å¼äº†ï¼Œæ€ä¹ˆè¿˜ä¼šæœ‰æ­»é”å‘¢ï¼Ÿ

è¿™é‡Œï¼Œæˆ‘ç”¨ä¸¤ä¸ªsessionæ¥æ¨¡æ‹Ÿå¹¶å‘ï¼Œå¹¶å‡è®¾N=9ã€‚

![img](https://static001.geekbang.org/resource/image/df/be/df37bf0bb9f85ea59f0540e24eb6bcbe.png)

å›¾8 é—´éš™é”å¯¼è‡´çš„æ­»é”

ä½ çœ‹åˆ°äº†ï¼Œå…¶å®éƒ½ä¸éœ€è¦ç”¨åˆ°åé¢çš„updateè¯­å¥ï¼Œå°±å·²ç»å½¢æˆæ­»é”äº†ã€‚æˆ‘ä»¬æŒ‰è¯­å¥æ‰§è¡Œé¡ºåºæ¥åˆ†æä¸€ä¸‹ï¼š

1. session A æ‰§è¡Œselect ... for updateè¯­å¥ï¼Œç”±äºid=9è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é”(5,10);
2. session B æ‰§è¡Œselect ... for updateè¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é”(5,10)ï¼Œé—´éš™é”ä¹‹é—´ä¸ä¼šå†²çªï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›
3. session B è¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Açš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›
4. session Aè¯•å›¾æ’å…¥ä¸€è¡Œ(9,9,9)ï¼Œè¢«session Bçš„é—´éš™é”æŒ¡ä½äº†ã€‚

è‡³æ­¤ï¼Œä¸¤ä¸ªsessionè¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚å½“ç„¶ï¼ŒInnoDBçš„æ­»é”æ£€æµ‹é©¬ä¸Šå°±å‘ç°äº†è¿™å¯¹æ­»é”å…³ç³»ï¼Œè®©session Açš„insertè¯­å¥æŠ¥é”™è¿”å›äº†ã€‚

ä½ ç°åœ¨çŸ¥é“äº†ï¼Œ**é—´éš™é”çš„å¼•å…¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒæ ·çš„è¯­å¥é”ä½æ›´å¤§çš„èŒƒå›´ï¼Œè¿™å…¶å®æ˜¯å½±å“äº†å¹¶å‘åº¦çš„**ã€‚å…¶å®ï¼Œè¿™è¿˜åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è¿˜ä¼šç¢°åˆ°æ›´å¤šã€æ›´å¤æ‚çš„ä¾‹å­ã€‚

ä½ å¯èƒ½ä¼šè¯´ï¼Œä¸ºäº†è§£å†³å¹»è¯»çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†è¿™ä¹ˆä¸€å¤§ä¸²å†…å®¹ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•ä¸€ç‚¹çš„å¤„ç†æ–¹æ³•å‘¢ã€‚

æˆ‘åœ¨æ–‡ç« ä¸€å¼€å§‹å°±è¯´è¿‡ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œä»Šå¤©å’Œä½ åˆ†æçš„é—®é¢˜éƒ½æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹çš„ï¼Œé—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„ã€‚æ‰€ä»¥ï¼Œä½ å¦‚æœæŠŠéš”ç¦»çº§åˆ«è®¾ç½®ä¸ºè¯»æäº¤çš„è¯ï¼Œå°±æ²¡æœ‰é—´éš™é”äº†ã€‚ä½†åŒæ—¶ï¼Œä½ è¦è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦æŠŠbinlogæ ¼å¼è®¾ç½®ä¸ºrowã€‚è¿™ï¼Œä¹Ÿæ˜¯ç°åœ¨ä¸å°‘å…¬å¸ä½¿ç”¨çš„é…ç½®ç»„åˆã€‚

å‰é¢æ–‡ç« çš„è¯„è®ºåŒºæœ‰åŒå­¦ç•™è¨€è¯´ï¼Œä»–ä»¬å…¬å¸å°±ä½¿ç”¨çš„æ˜¯è¯»æäº¤éš”ç¦»çº§åˆ«åŠ binlog_format=rowçš„ç»„åˆã€‚ä»–æ›¾é—®ä»–ä»¬å…¬å¸çš„DBAè¯´ï¼Œä½ ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆé…ç½®ã€‚DBAç›´æ¥ç­”å¤è¯´ï¼Œå› ä¸ºå¤§å®¶éƒ½è¿™ä¹ˆç”¨å‘€ã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ªåŒå­¦åœ¨è¯„è®ºåŒºå°±é—®è¯´ï¼Œè¿™ä¸ªé…ç½®åˆ°åº•åˆä¸åˆç†ã€‚

å…³äºè¿™ä¸ªé—®é¢˜æœ¬èº«çš„ç­”æ¡ˆæ˜¯ï¼Œå¦‚æœè¯»æäº¤éš”ç¦»çº§åˆ«å¤Ÿç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸šåŠ¡ä¸éœ€è¦å¯é‡å¤è¯»çš„ä¿è¯ï¼Œè¿™æ ·è€ƒè™‘åˆ°è¯»æäº¤ä¸‹æ“ä½œæ•°æ®çš„é”èŒƒå›´æ›´å°ï¼ˆæ²¡æœ‰é—´éš™é”ï¼‰ï¼Œè¿™ä¸ªé€‰æ‹©æ˜¯åˆç†çš„ã€‚

ä½†å…¶å®æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œé…ç½®æ˜¯å¦åˆç†ï¼Œè·Ÿä¸šåŠ¡åœºæ™¯æœ‰å…³ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚

ä½†æ˜¯ï¼Œå¦‚æœDBAè®¤ä¸ºä¹‹æ‰€ä»¥è¿™ä¹ˆç”¨çš„åŸå› æ˜¯â€œå¤§å®¶éƒ½è¿™ä¹ˆç”¨â€ï¼Œé‚£å°±æœ‰é—®é¢˜äº†ï¼Œæˆ–è€…è¯´ï¼Œè¿Ÿæ—©ä¼šå‡ºé—®é¢˜ã€‚

æ¯”å¦‚è¯´ï¼Œå¤§å®¶éƒ½ç”¨è¯»æäº¤ï¼Œå¯æ˜¯é€»è¾‘å¤‡ä»½çš„æ—¶å€™ï¼Œmysqldumpä¸ºä»€ä¹ˆè¦æŠŠå¤‡ä»½çº¿ç¨‹è®¾ç½®æˆå¯é‡å¤è¯»å‘¢ï¼Ÿï¼ˆè¿™ä¸ªæˆ‘åœ¨å‰é¢çš„æ–‡ç« ä¸­å·²ç»è§£é‡Šè¿‡äº†ï¼Œä½ å¯ä»¥å†å›é¡¾ä¸‹ç¬¬6ç¯‡æ–‡ç« [ã€Šå…¨å±€é”å’Œè¡¨é” ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆæœ‰è¿™ä¹ˆå¤šé˜»ç¢ï¼Ÿã€‹](https://time.geekbang.org/column/article/69862)çš„å†…å®¹ï¼‰

ç„¶åï¼Œåœ¨å¤‡ä»½æœŸé—´ï¼Œå¤‡ä»½çº¿ç¨‹ç”¨çš„æ˜¯å¯é‡å¤è¯»ï¼Œè€Œä¸šåŠ¡çº¿ç¨‹ç”¨çš„æ˜¯è¯»æäº¤ã€‚åŒæ—¶å­˜åœ¨ä¸¤ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ

è¿›ä¸€æ­¥åœ°ï¼Œè¿™ä¸¤ä¸ªä¸åŒçš„éš”ç¦»çº§åˆ«ç°è±¡æœ‰ä»€ä¹ˆä¸ä¸€æ ·çš„ï¼Œå…³äºæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œâ€œç”¨è¯»æäº¤å°±å¤Ÿäº†â€è¿™ä¸ªç»“è®ºæ˜¯æ€ä¹ˆå¾—åˆ°çš„ï¼Ÿ

å¦‚æœä¸šåŠ¡å¼€å‘å’Œè¿ç»´å›¢é˜Ÿè¿™äº›é—®é¢˜éƒ½æ²¡æœ‰å¼„æ¸…æ¥šï¼Œé‚£ä¹ˆâ€œæ²¡é—®é¢˜â€è¿™ä¸ªç»“è®ºï¼Œæœ¬èº«å°±æ˜¯æœ‰é—®é¢˜çš„ã€‚

# å°ç»“

ä»Šå¤©æˆ‘ä»¬ä»ä¸Šä¸€ç¯‡æ–‡ç« çš„è¯¾åé—®é¢˜è¯´èµ·ï¼Œæåˆ°äº†å…¨è¡¨æ‰«æçš„åŠ é”æ–¹å¼ã€‚æˆ‘ä»¬å‘ç°å³ä½¿ç»™æ‰€æœ‰çš„è¡Œéƒ½åŠ ä¸Šè¡Œé”ï¼Œä»ç„¶æ— æ³•è§£å†³å¹»è¯»é—®é¢˜ï¼Œå› æ­¤å¼•å…¥äº†é—´éš™é”çš„æ¦‚å¿µã€‚

æˆ‘ç¢°åˆ°è¿‡å¾ˆå¤šå¯¹æ•°æ®åº“æœ‰ä¸€å®šäº†è§£çš„ä¸šåŠ¡å¼€å‘äººå‘˜ï¼Œä»–ä»¬åœ¨è®¾è®¡æ•°æ®è¡¨ç»“æ„å’Œä¸šåŠ¡SQLè¯­å¥çš„æ—¶å€™ï¼Œå¯¹è¡Œé”æœ‰å¾ˆå‡†ç¡®çš„è®¤è¯†ï¼Œä½†å´å¾ˆå°‘è€ƒè™‘åˆ°é—´éš™é”ã€‚æœ€åçš„ç»“æœï¼Œå°±æ˜¯ç”Ÿäº§åº“ä¸Šä¼šç»å¸¸å‡ºç°ç”±äºé—´éš™é”å¯¼è‡´çš„æ­»é”ç°è±¡ã€‚

è¡Œé”ç¡®å®æ¯”è¾ƒç›´è§‚ï¼Œåˆ¤æ–­è§„åˆ™ä¹Ÿç›¸å¯¹ç®€å•ï¼Œé—´éš™é”çš„å¼•å…¥ä¼šå½±å“ç³»ç»Ÿçš„å¹¶å‘åº¦ï¼Œä¹Ÿå¢åŠ äº†é”åˆ†æçš„å¤æ‚åº¦ï¼Œä½†ä¹Ÿæœ‰ç« å¯å¾ªã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘å°±ä¼šä¸ºä½ è®²è§£InnoDBçš„åŠ é”è§„åˆ™ï¼Œå¸®ä½ ç†é¡ºè¿™å…¶ä¸­çš„â€œç« æ³•â€ã€‚

ä½œä¸ºå¯¹ä¸‹ä¸€ç¯‡æ–‡ç« çš„é¢„ä¹ ï¼Œæˆ‘ç»™ä½ ç•™ä¸‹ä¸€ä¸ªæ€è€ƒé¢˜ã€‚

![img](https://static001.geekbang.org/resource/image/0d/3d/0d796060073668ca169166a8903fbf3d.png)

å›¾9 äº‹åŠ¡è¿›å…¥é”ç­‰å¾…çŠ¶æ€

å¦‚æœä½ ä¹‹å‰æ²¡æœ‰äº†è§£è¿‡æœ¬ç¯‡æ–‡ç« çš„ç›¸å…³å†…å®¹ï¼Œä¸€å®šè§‰å¾—è¿™ä¸‰ä¸ªè¯­å¥ç®€ç›´æ˜¯é£é©¬ç‰›ä¸ç›¸åŠã€‚ä½†å®é™…ä¸Šï¼Œè¿™é‡Œsession Bå’Œsession Cçš„insert è¯­å¥éƒ½ä¼šè¿›å…¥é”ç­‰å¾…çŠ¶æ€ã€‚

ä½ å¯ä»¥è¯•ç€åˆ†æä¸€ä¸‹ï¼Œå‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™å…¶å®æ˜¯æˆ‘åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»åŠ é”è§„åˆ™åæ‰èƒ½å›ç­”çš„é—®é¢˜ï¼Œæ˜¯ç•™ç»™ä½ ä½œä¸ºé¢„ä¹ çš„ï¼Œå…¶ä¸­session Cè¢«é”ä½è¿™ä¸ªåˆ†ææ˜¯æœ‰ç‚¹éš¾åº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åˆ†æå‡ºæ¥ï¼Œä¹Ÿä¸è¦æ°”é¦ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å’Œä½ è¯¦ç»†è¯´æ˜ã€‚

ä½ ä¹Ÿå¯ä»¥è¯´è¯´ï¼Œä½ çš„çº¿ä¸ŠMySQLé…ç½®çš„æ˜¯ä»€ä¹ˆéš”ç¦»çº§åˆ«ï¼Œä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆé…ç½®ï¼Ÿä½ æœ‰æ²¡æœ‰ç¢°åˆ°ä»€ä¹ˆåœºæ™¯ï¼Œæ˜¯å¿…é¡»ä½¿ç”¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«çš„å‘¢ï¼Ÿ

ä½ å¯ä»¥æŠŠä½ çš„ç¢°åˆ°çš„åœºæ™¯å’Œåˆ†æå†™åœ¨ç•™è¨€åŒºé‡Œï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« é€‰å–æœ‰è¶£çš„è¯„è®ºè·Ÿå¤§å®¶ä¸€èµ·åˆ†äº«å’Œåˆ†æã€‚æ„Ÿè°¢ä½ çš„æ”¶å¬ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ä¸€èµ·é˜…è¯»ã€‚

# ä¸ŠæœŸé—®é¢˜æ—¶é—´

æˆ‘ä»¬åœ¨æœ¬æ–‡çš„å¼€å¤´å›ç­”äº†ä¸ŠæœŸé—®é¢˜ã€‚æœ‰åŒå­¦çš„å›ç­”ä¸­è¿˜è¯´æ˜äº†è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œæ˜¯åªæœ‰è¡Œé”çš„ã€‚è€Œä¸”è¯­å¥æ‰§è¡Œå®Œæˆåï¼ŒInnoDBå°±ä¼šæŠŠä¸æ»¡è¶³æ¡ä»¶çš„è¡Œè¡Œé”å»æ‰ã€‚

å½“ç„¶äº†ï¼Œc=5è¿™ä¸€è¡Œçš„è¡Œé”ï¼Œè¿˜æ˜¯ä¼šç­‰åˆ°commitçš„æ—¶å€™æ‰é‡Šæ”¾çš„ã€‚

è¯„è®ºåŒºç•™è¨€ç‚¹èµæ¿ï¼š

> @è–›ç•… ã€@å¼ æ°¸å¿—åŒå­¦ç»™å‡ºäº†æ­£ç¡®ç­”æ¡ˆã€‚è€Œä¸”æåˆ°äº†åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ˜¯åªæœ‰è¡Œé”çš„ã€‚
> @å¸†å¸†å¸†å¸†å¸†å¸†å¸†å¸†ã€@æ¬§é˜³æˆ å¯¹ä¸ŠæœŸçš„ä¾‹å­åšäº†éªŒè¯ï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œéœ€è¦åœ¨å¯åŠ¨é…ç½®é‡Œé¢å¢åŠ performance_schema=onï¼Œæ‰èƒ½ç”¨ä¸Šè¿™ä¸ªåŠŸèƒ½ï¼Œperformance_schemaåº“é‡Œçš„è¡¨æ‰æœ‰æ•°æ®ã€‚

![img](https://static001.geekbang.org/resource/image/09/77/09c1073f99cf71d2fb162a716b5fa577.jpg)

## ç²¾é€‰ç•™è¨€

- 

  ä»¤ç‹å°‘ä¾ 

  è€å¸ˆï¼Œä»Šå¤©çš„æ–‡ç« å¯¹æˆ‘å½±å“å¾ˆå¤§ï¼Œå‘ç°ä¹‹å‰æŒæ¡çš„çŸ¥è¯†æœ‰äº›é”™è¯¯çš„åœ°æ–¹ï¼Œè¯¾åæˆ‘ç”¨ä½ çš„è¡¨ç»“æ„æ ¹æ®ä»¥å‰ä¸æ¸…æ¥šçš„åœ°æ–¹å®è·µäº†ä¸€éï¼Œç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œéº»çƒ¦æ‚¨è§£ç­”ä¸‹
  1.æˆ‘åœ¨äº‹åŠ¡1ä¸­æ‰§è¡Œ begin;select * from t where c=5 for update;äº‹åŠ¡æœªæäº¤ï¼Œç„¶åäº‹åŠ¡2ä¸­begin;update t set c=5 where id=0;æ‰§è¡Œé˜»å¡ï¼Œæ›¿æ¢æˆupdate t set c=11 where id=0;æ‰§è¡Œä¸é˜»å¡ï¼Œæˆ‘è§‰å¾—åŸå› æ˜¯äº‹åŠ¡1æ‰§è¡Œæ—¶äº§ç”Ÿnext-key lockèŒƒå›´æ˜¯(0,5].(5,10]ã€‚æˆ‘æƒ³é—®ä¸‹update setæ“ä½œc=xxxæ˜¯ä¼šåŠ é”å—ï¼Ÿä»¥åŠåŠ é”çš„åŸç†ã€‚
  2.ä¸€ç›´ä»¥ä¸ºgapåªä¼šåœ¨äºŒçº§ç´¢å¼•ä¸Šï¼Œçœ‹äº†ä½ çš„æ­»é”æ¡ˆä¾‹ï¼Œå‘ç°ä¸»é”®ç´¢å¼•ä¸Šä¹Ÿä¼šæœ‰gapé”ï¼Ÿ

  2018-12-28 15:37

  ä½œè€…å›å¤

  \1. å¥½é—®é¢˜ã€‚ä½ å¯ä»¥ç†è§£ä¸ºè¦åœ¨ç´¢å¼•cä¸Šæ’å…¥ä¸€ä¸ª(c=5,id=0)è¿™ä¸€è¡Œï¼Œæ˜¯è½åœ¨(0,5],(5,10]é‡Œé¢çš„ï¼Œ11å¯ä»¥å¯¹å§

  \2. å—¯ï¼Œä¸»é”®ç´¢å¼•çš„é—´éš™ä¸Šä¹Ÿè¦æœ‰Gap lockä¿æŠ¤çš„

  2018-12-28 15:54

- 

  è–›ç•…

  å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œç»è¯•éªŒï¼š
  SELECT * FROM t where c>=15 and c<=20 for update; ä¼šåŠ å¦‚ä¸‹é”ï¼š
  next-key lock:(10, 15], (15, 20]
  gap lock:(20, 25)

  SELECT * FROM t where c>=15 and c<=20 order by c desc for update; ä¼šåŠ å¦‚ä¸‹é”ï¼š
  next-key lock:(5, 10], (10, 15], (15, 20]
  gap lock:(20, 25)

  session C è¢«é”ä½çš„åŸå› å°±æ˜¯æ ¹æ®ç´¢å¼• c é€†åºæ’åºåå¤šå‡ºçš„ next-key lock:(5, 10]

  åŒæ—¶æˆ‘æœ‰ä¸ªç–‘é—®ï¼šåŠ ä¸åŠ  next-key lock:(5, 10] å¥½åƒéƒ½ä¸ä¼šå½±å“åˆ° session A å¯é‡å¤è¯»çš„è¯­ä¹‰ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¦åŠ è¿™ä¸ªé”å‘¢ï¼Ÿ

  2018-12-29 09:03

  ä½œè€…å›å¤

  æ˜¯çš„ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯ä¸ºå•¥æ€»ç»“è§„åˆ™æœ‰ç‚¹éº»çƒ¦ï¼Œæœ‰æ—¶å€™åªæ˜¯å› ä¸ºä»£ç æ˜¯è¿™ä¹ˆå†™çš„ğŸ˜“

  2018-12-29 09:18

- 

  AIæœå˜‰å˜‰

  è¯´çœŸçš„ï¼Œè¿™ä¸€ç³»åˆ—æ–‡ç« å®ç”¨æ€§çœŸçš„å¾ˆå¼ºï¼Œè€å¸ˆéå¸¸è´Ÿè´£ï¼Œæƒ³å¿…ç‰µæ‰¯åˆ°è€å¸ˆå¤§é‡ç²¾åŠ›ï¼Œå¸Œæœ›è€å¸ˆå†å‡ºå¥½æ–‡ç« ï¼Œè°¢è°¢æ‚¨äº†ï¼Œè¾›è‹¦äº†

  2018-12-28 13:59

  ä½œè€…å›å¤

  ç²¾åŠ›èŠ±äº†æ²¡äº‹ï¼Œç¡ä¸€è§‰é†’æ¥è¿˜æ˜¯ä¸€æ¡å¥½æ±‰ğŸ˜„
  ä¸»è¦è¿˜æ˜¯å¾—å¤§å®¶æœ‰æ”¶è·ï¼Œæˆ‘å°±å€¼äº†ğŸ˜„

  2018-12-28 19:03

- 

  éƒ­æ±Ÿä¼Ÿ

  insert into t values(0,0,0),(5,5,5),
  (10,10,10),(15,15,15),(20,20,20),(25,25,25);
  è¿è¡Œmysql> begin;
  Query OK, 0 rows affected (0.00 sec)
  mysql> select * from t where c>=15 and c<=20 order by c desc for update;
  c ç´¢å¼•ä¼šåœ¨æœ€å³ä¾§åŒ…å«ä¸»é”®å€¼ï¼Œcç´¢å¼•çš„å€¼ä¸º(0,0) (5,5) (10,10) (15,15) (20,20) (25,25)
  æ­¤æ—¶cç´¢å¼•ä¸Šé”çš„èŒƒå›´å…¶å®è¿˜è¦åŒ¹é…ä¸»é”®å€¼ ã€‚
  æ€è€ƒé¢˜ç­”æ¡ˆæ˜¯ï¼Œä¸Šé™ä¼šæ‰«åˆ°cç´¢å¼•(20,20) ä¸Šä¸€ä¸ªé”®ï¼Œä¸ºäº†é˜²æ­¢cä¸º20 ä¸»é”®å€¼å°äº25 çš„è¡Œæ’å…¥ï¼Œéœ€è¦é”å®š(20,20) (25,25) ä¸¤è€…çš„é—´éš™ï¼›å¼€å¯å¦ä¸€ä¼šè¯(26,25,25)å¯ä»¥æ’å…¥ï¼Œè€Œ(24,25,25)ä¼šè¢«å µå¡ã€‚
  ä¸‹é™ä¼šæ‰«æåˆ°(15,15)çš„ä¸‹ä¸€ä¸ªé”®ä¹Ÿå°±æ˜¯(10,10),æµ‹è¯•è¯­å¥ä¼šç»§ç»­æ‰«æä¸€ä¸ªé”®å°±æ˜¯(5,5) ï¼Œæ­¤æ—¶ä¼šé”å®šï¼Œ(5,5) åˆ°(15,15)çš„é—´éš™ï¼Œç”±äºidæ˜¯ä¸»é”®ä¸å¯é‡å¤æ‰€ä»¥ä¸‹é™ä¹Ÿæ˜¯é—­åŒºé—´ï¼›
  åœ¨æœ¬ä¾‹çš„æµ‹è¯•æ•°æ®ä¸­æ·»åŠ (21,25,25)åå°±å¯ä»¥æ­£å¸¸æ’å…¥(24,25,25)

  2018-12-28 13:38

  ä½œè€…å›å¤

  æ„Ÿè§‰ä½ ä¸‹ä¸€ç¯‡çœ‹èµ·æ¥ä¼šå¾ˆè½»æ¾äº†å“ˆğŸ‘ğŸ¿

  2018-12-28 19:04

- 

  æ…§é‘«coming

  è¿™ç¯‡éœ€è¦å¤šè¯»å‡ éï¼Œagain

  2018-12-28 08:24

- 

  æ²‰æµ®

  é€šè¿‡æ‰“å°é”æ—¥å¿—å¸®åŠ©ç†è§£é—®é¢˜
  é”ä¿¡æ¯è§æ‹¬å·é‡Œçš„è¯´æ˜ã€‚

  TABLE LOCK table `guo_test`.`t` trx id 105275 lock mode IX
  RECORD LOCKS space id 31 page no 4 n bits 80 index c of table `guo_test`.`t` trx id 105275 lock_mode X
  Record lock, heap no 4 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 ----(Next-Key Lockï¼Œç´¢å¼•é”cï¼ˆ5ï¼Œ10])
  0: len 4; hex 8000000a; asc ;;
  1: len 4; hex 8000000a; asc ;;

  Record lock, heap no 5 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 ----(Next-Key Lockï¼Œç´¢å¼•é”c (10,15])
  0: len 4; hex 8000000f; asc ;;
  1: len 4; hex 8000000f; asc ;;

  Record lock, heap no 6 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 ----(Next-Key Lockï¼Œç´¢å¼•é”c (15,20])
  0: len 4; hex 80000014; asc ;;
  1: len 4; hex 80000014; asc ;;

  Record lock, heap no 7 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 ----(Next-Key Lockï¼Œç´¢å¼•é”c (20,25])
  0: len 4; hex 80000019; asc ;;
  1: len 4; hex 80000019; asc ;;

  RECORD LOCKS space id 31 page no 3 n bits 80 index PRIMARY of table `guo_test`.`t` trx id 105275 lock_mode X locks rec but not gap
  Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
  ----(è®°å½•é” é”c=15å¯¹åº”çš„ä¸»é”®ï¼‰
  0: len 4; hex 8000000f; asc ;;
  1: len 6; hex 0000000199e3; asc ;;
  2: len 7; hex ca000001470134; asc G 4;;
  3: len 4; hex 8000000f; asc ;;
  4: len 4; hex 8000000f; asc ;;

  Record lock, heap no 6 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
  0: len 4; hex 80000014; asc ;;
  ----(è®°å½•é” é”c=20å¯¹åº”çš„ä¸»é”®ï¼‰
  1: len 6; hex 0000000199e3; asc ;;
  2: len 7; hex ca000001470140; asc G @;;
  3: len 4; hex 80000014; asc ;;
  4: len 4; hex 80000014; asc ;;
  ç”±äºå­—æ•°é™åˆ¶ï¼Œæ­£åºåŠæ— æ’åºçš„æ—¥å¿—æ— æ³•å¸–å‡ºï¼Œå€’åºæ—¥å¿—æ¯”è¿™ä¸¤è€…ï¼Œå¤šäº†èŒƒå›´(Next-Key Lockï¼Œç´¢å¼•é”cï¼ˆ5ï¼Œ10])ï¼Œä¸ªäººç†è§£æ˜¯ï¼ŒåŠ é”åˆ†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ï¼Œå³æ­£åºçš„é”ï¼Œç¬¬äºŒæ¬¡ä¸ºå€’åºçš„é”ï¼Œå³å¤šå‡ºçš„(5,10],åœ¨RRéš”ç¦»çº§åˆ«ï¼Œ
  innodbåœ¨åŠ é”çš„è¿‡ç¨‹ä¸­ä¼šé»˜è®¤å‘åé”ä¸€ä¸ªè®°å½•ï¼ŒåŠ ä¸ŠNext-Key Lock,ç¬¬ä¸€æ¬¡åŠ é”çš„æ—¶å€™10å·²ç»åœ¨èŒƒå›´ï¼Œç”±äºå€’åºï¼Œå‘åï¼Œå³å‘5å†åŠ Next-key Lock,å³å¤šå‡ºçš„(5,10]èŒƒå›´

  2018-12-28 16:06

  ä½œè€…å›å¤

  ä¼˜ç§€

  2018-12-28 17:14

- 

  å¾€äº‹éšé£ï¼Œé¡ºå…¶è‡ªç„¶

  æ€»ç»“ï¼šfor update æ˜¯é”ä½æ‰€æœ‰è¡Œè¿˜æœ‰é—´éš™é”ï¼Œä½†æ˜¯é—´éš™ğŸ”’ä¹‹é—´äº’ä¸å†²çªï¼Œä½†æ˜¯äº’ä¸å†²çªï¼Œä¸ºä»€ä¹ˆæ’å…¥9è¿™ä¸€è¡Œä¼šè¢«é—´éš™é”ç­‰å¾…ï¼ŒåŸæ¥æ²¡æœ‰è¿™ä¸€è¡Œï¼Œè¿™å’ŒæŸ¥è¯¢9è¿™ä¸€è¡Œä¸æ˜¯ä¸€æ ·ï¼Ÿ

  2018-12-28 08:09

- 

  en

  è€å¸ˆæ‚¨å¥½ï¼Œæˆ‘mysqlçš„éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œæ•°æ®æ˜¯(0,0,0),(5,5,5),(10,10,10),(15,15,15),(20,20,20),(25,25,25)ï¼Œä½¿ç”¨äº†begin;select * from t where c>=15 and c<=20 order by c desc for update;ç„¶åsessionBçš„11é˜»å¡äº†ï¼Œä½†æ˜¯(6,6,6)çš„æ’å…¥æˆåŠŸäº†è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ

  2018-12-31 10:21

- 

  éƒ­å¥

  è€å¸ˆï¼Œæƒ³è¯·æ•™æ‚¨å‡ ä¸ªé—®é¢˜ã€‚1.åœ¨ç¬¬å…­ç« MDLé”çš„æ—¶å€™ï¼Œæ‚¨è¯´ç»™å¤§è¡¨å¢åŠ å­—æ®µå’Œå¢åŠ ç´¢å¼•çš„æ—¶å€™è¦å°å¿ƒï¼Œä¹‹å‰åšè¿‡æµ‹è¯•ï¼Œç»™ä¸€ä¸ªä¸€åƒä¸‡çš„æ•°æ®å¢åŠ ç´¢å¼•æœ‰æ—¶éœ€è¦40åˆ†é’Ÿï¼Œä½†æ˜¯å¢åŠ ç´¢å¼•ä¸ä¼šå¯¹è¡¨å¢åŠ MDLé”å§ã€‚é™¤äº†å¢åŠ ç´¢å¼•æ…¢ï¼Œè¿˜ä¼šå¯¹æ•°æ®åº“æœ‰ä»€ä¹ˆå½±å“å—ï¼Œæˆ‘é—®æˆ‘ä»¬dbaï¼Œä»–è¯´å°±å¼€å§‹å’Œç»“æŸçš„æ—¶å€™ä¸Šä¸€ä¸‹é”ï¼Œæ²¡ä»€ä¹ˆå½±å“ï¼Œæˆ‘ä¸ªäººæ˜¯æŒæ€€ç–‘æ€åº¦çš„ã€‚2ï¼Œè€å¸ˆè®²åˆ°è¡¨é”é™¤äº†MDLé”ï¼Œè¿˜æœ‰æ˜¾ç¤ºå‘½ä»¤lock tableçš„å‘½ä»¤çš„è¡¨é”ï¼Œè€å¸ˆæˆ‘å¯ä»¥è®¤ä¸ºï¼Œåœ¨mysqlä¸­å¦‚æœä¸æ˜¾ç¤ºä½¿ç”¨lock tableè¡¨é”çš„è¯ï¼Œé‚£ä¹ˆmysqlæ˜¯æ°¸è¿œä¸ä¼šä½¿ç”¨è¡¨é”çš„ï¼Œå¦‚æœé”çš„æ¡ä»¶æ²¡æœ‰ç´¢å¼•ï¼Œä½¿ç”¨çš„æ˜¯é”ä½è¡Œé”+é—´éš™æ§åˆ¶å¹¶å‘ã€‚

  2018-12-30 16:13

  ä½œè€…å›å¤

  \1. åœ¨é”æ–¹é¢ä½ ä»¬dbaè¯´çš„åŸºæœ¬æ˜¯å¯¹çš„ã€‚ä¸€å¼€å§‹å’Œç»“æŸæœ‰å†™é”ï¼Œæ‰§è¡Œä¸­é—´40åˆ†é’Ÿåªæœ‰è¯»é”
  ä½†æ˜¯1000ä¸‡çš„è¡¨è¦åš40åˆ†é’Ÿï¼Œå¯èƒ½æ„å‘³ç€ç³»ç»Ÿå‹åŠ›å¤§ï¼ˆæˆ–è€…é…ç½®åå°ï¼‰ï¼Œè¿™æ ·å¯èƒ½ä¸æ˜¯æ²¡å½±å“å¯¹ï¼Œæ¯”è¾ƒè¿™ä¸ªæ“ä½œè¿˜æ˜¯è¦åƒIOå’ŒCPUçš„

  \2. å—¯ï¼Œinnodbå¼•æ“æ˜¯è¿™æ ·çš„ã€‚

  2018-12-30 19:23

- 

  æ»”æ»”

  è€å¸ˆï¼Œå¬äº†æ‚¨çš„è¯¾æ”¶è·æ»¡æ»¡ï½ï½æ„Ÿè°¢æ‚¨çš„ä»˜å‡ºï¼æ‚¨å¯ä¸å¯ä»¥åœ¨åˆ†ææ­»é”çš„æ—¶å€™è®²ä¸€ä¸‹å¦‚ä½•åˆ†ææ­»é”æ—¥å¿—ï¼ŒæœŸå¾…ï½ï½ğŸ˜€

  2018-12-29 18:20

  ä½œè€…å›å¤

  è°¢è°¢ä½ çš„è‚¯å®šã€‚

  å—¯æ­»é”åˆ†æä¼šæœ‰ä¸€ç¯‡ä¸“é—¨è¯´ã€‚

  ä¸è¿‡ä½ å¯ä»¥æå‰è¯´ä¸€ä¸‹ç¢°åˆ°çš„ç–‘é—®ğŸ˜„

  2018-12-29 20:08

- 

  èƒ¡æœˆğŸŒˆ

  è€å¸ˆï¼Œä»Šå¤©çº¿ä¸Šé‡ä¸Šäº†ä¸€ä¸ªæ­»é”çš„é—®é¢˜ï¼Œæ‚¨èƒ½å¸®æˆ‘åˆ†æä¸‹å—ã€‚
  æ ¹æ®å‰é¢æ–‡ç« çš„ç†è§£ï¼šæ­»é”äº§ç”Ÿçš„åŸå› å¦‚ä¸‹
  çº¿ç¨‹1ï¼šupdateè¯­å¥where c= 1 ç„¶å updateè¯­å¥where c=2
  çº¿ç¨‹2ï¼šupdateè¯­å¥where c=2ç„¶å updateè¯­å¥where c=1
  å¦‚æœçº¿ç¨‹1è·å–c=1çš„é”ï¼Œç­‰å¾…c=2çš„é”ï¼Œçº¿ç¨‹2è·å–äº†c=2çš„é”ï¼Œç­‰å¾…c=1çš„é”ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ã€‚
  ä½†æ˜¯çº¿ä¸Šçš„æƒ…å†µæ˜¯
  çº¿ç¨‹1ï¼šupdateè¯­å¥where c= 1 ç„¶å updateè¯­å¥where c=2
  çº¿ç¨‹2ï¼šupdateè¯­å¥where c=1ç„¶å updateè¯­å¥where c=2
  æŒ‰è¯´ä¸ä¼šäº§ç”Ÿæ­»é”å•Šï¼Œå› ä¸ºå¦‚æœçº¿ç¨‹1è·å–äº†c=1çš„é”ï¼Œçº¿ç¨‹2å°±é˜»å¡äº†ã€‚çº¿ç¨‹1æ‰§è¡Œå®Œä¹‹åï¼Œçº¿ç¨‹2æ‰§è¡Œå°±å¯ä»¥äº†æ­»é”æ—¥å¿—å¦‚ä¸‹ï¼š

  (1) TRANSACTION:
  TRANSACTION 9418928, ACTIVE 0.088 sec fetching rows
  mysql tables in use 1, locked 1
  LOCK WAIT 66 lock struct(s), heap size 13864, 8 row lock(s)
  LOCK BLOCKING MySQL thread id: 11495130 block 11105198
  MySQL thread id 11105198, OS thread handle 0x2b086bf45700, query id 88822589 39.106.161.89 daogou Searching rows for update
  UPDATE union_pid
  SET USE_TIMES = USE_TIMES + 1
  WHERE PID = 'mm_128160800_40474215_33107450401'
  (1) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418928 lock_mode X locks rec but not gap waiting
  Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0

  (2) TRANSACTION:
  TRANSACTION 9418929, ACTIVE 0.088 sec fetching rows
  mysql tables in use 1, locked 1
  280 lock struct(s), heap size 46632, 17 row lock(s), undo log entries 1
  MySQL thread id 11495130, OS thread handle 0x2b086be41700, query id 88822594 39.106.161.89 daogou Searching rows for update
  UPDATE union_pid
  SET USE_TIMES = USE_TIMES + 1
  WHERE PID = '1000501132_0_1432392817'
  (2) HOLDS THE LOCK(S):
  RECORD LOCKS space id 134 page no 93 n bits 192 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap
  Record lock, heap no 86 PHYSICAL RECORD: n_fields 12; compact format; info bits 0

  (2) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 134 page no 68 n bits 264 index `PRIMARY` of table `shanfan`.`union_pid` trx id 9418929 lock_mode X locks rec but not gap waiting
  Record lock, heap no 116 PHYSICAL RECORD: n_fields 12; compact format; info bits 0

  WE ROLL BACK TRANSACTION (1)

  2018-12-29 18:08

  ä½œè€…å›å¤

  PIDæ˜¯å”¯ä¸€ç´¢å¼•å—ï¼Ÿ ç»™ä¸€ä¸‹è¡¨ç»“æ„ã€‚è¿™ä¸¤ä¸ªè¯­å¥åˆ†åˆ«å¯¹åº”çš„ä¸»é”®IDå¦‚æœå•ç‹¬æŸ¥å‡ºæ¥åˆ†åˆ«æ˜¯å¤šå°‘

  2018-12-29 20:33

- 

  é«˜æ•

  æ—è€å¸ˆï¼Œä»Šå¤©æˆ‘åˆå›å¤´çœ‹ç¬¬å››èŠ‚ æ·±å…¥æµ…å‡ºè°ˆç´¢å¼•ï¼ˆä¸Šï¼‰ï¼Œé‡Œé¢æœ‰è¿™æ ·ä¸€æ®µè¯ï¼šä¸ºäº†è®©ä¸€ä¸ªæŸ¥è¯¢å°½é‡å°‘åœ°è¯»ç£ç›˜ï¼Œå°±å¿…é¡»è®©æŸ¥è¯¢è¿‡ç¨‹è®¿é—®å°½é‡å°‘çš„æ•°æ®å—ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸åº”è¯¥ä½¿ç”¨äºŒå‰æ ‘ï¼Œè€Œæ˜¯è¦ä½¿ç”¨â€œN å‰â€æ ‘ã€‚è¿™é‡Œï¼Œâ€œN å‰â€æ ‘ä¸­çš„â€œNâ€å–å†³äºæ•°æ®å—çš„å¤§å°ã€‚
  æˆ‘æƒ³é—®çš„æ˜¯ï¼Œ
  ä¸€ mysqlæ˜¯ä»¥pageä¸ºæœ€å°å•ä½çš„ï¼Œmysqlä¸€æ¬¡ç£ç›˜ioèƒ½åªè¯»ä¸€ä¸ªå—å—ï¼Ÿè¿˜æ˜¯å¤šä¸ªå—ç»„æˆçš„pageï¼Ÿ
  äºŒ è‹¥ä¸€æ¬¡åªèƒ½è¯»ä¸€ä¸ªpageï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªå—çš„è¯ï¼Œè¿™ä¸ªNçš„å¤§å°æ˜¯ä¸æ˜¯åº”è¯¥å–å†³äºpageçš„å¤§å°å‘¢ï¼Ÿ
  ä¸‰ ä¸»é”®ç´¢å¼•å¶å­ç»“ç‚¹å­˜æ”¾çš„å®é™…æ•°æ®ï¼Œåº”è¯¥æ˜¯é€šè¿‡æŒ‡é’ˆè·Ÿå¶å­ç»“ç‚¹è¿æ¥çš„å—ï¼Ÿè¿˜æ˜¯ç›´æ¥å­˜åœ¨å¶å­ç»“ç‚¹æ‰€åœ¨çš„é¡µé‡Œå—ï¼Ÿ

  2018-12-29 12:21

- 

  ä¿¡ä¿¡

  è€å¸ˆä½ å¥½ï¼Œå¦‚æœå›¾1çš„å­—æ®µdæœ‰ç´¢å¼•ï¼ŒæŒ‰å‰é¢è¯´çš„T1æ—¶åˆ»åï¼Œåªæœ‰idç­‰äº5è¿™ä¸€è¡ŒåŠ äº†å†™é”ã€‚é‚£ä¹ˆsession B æ“ä½œçš„æ˜¯idç­‰äº0è¿™ä¸€è¡Œï¼Œåº”è¯¥ä¸ä¼šè¢«é˜»æ–­å§ï¼Ÿå¦‚æœæ²¡é˜»æ–­çš„è¯ï¼Œä»ç„¶ä¼šäº§ç”Ÿè¯­ä¹‰é—®é¢˜åŠæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µå•Šã€‚æƒ³ä¸æ˜ç™½ã€‚ã€‚ã€‚

  2018-12-29 00:36

  ä½œè€…å›å¤

  å¦‚æœdæœ‰ç´¢å¼•ï¼Œè€Œä¸”å†™æ³•æ˜¯d=5ï¼Œé‚£ä¹ˆå…¶ä»–è¯­å¥è¦æŠŠå…¶ä»–è¡Œçš„dæ”¹æˆ5ï¼Œä¹Ÿæ˜¯ä¸è¡Œçš„å“¦

  2018-12-29 09:15

- 

  å¯å‡¡ä¸å‡¡

  è€å¸ˆ
  update tab1 set name =(select name from tab2 where status =2)...
  tab2.status ä¸Šæœ‰äºŒçº§éå”¯ä¸€ç´¢å¼•,rr éš”ç¦»çº§åˆ«
  ä¸Šè¿°æƒ…å†µ
  tab2.id ä¸Šçš„çš„ç´¢å¼•ä¼šè¢«é”å—?
  å®é™…å¼€å‘ çœ‹åˆ°çš„æ­»é”æƒ…å†µ æ˜¯è¿™æ¡è¯­å¥åœ¨ç­‰å¾… s é” ä½†æ˜¯æ²¡æœ‰ gap é”,ä¹Ÿæ²¡æœ‰è®¾ç½® semi-consistent read

  2018-12-28 09:44

  ä½œè€…å›å¤

  Tab2æ»¡è¶³æ¡ä»¶çš„èˆªä¸Šä¼šåŠ è¯»é”

  2018-12-28 10:05

- 

  å°æ–°

  è¿™ç¯‡æ–‡ç« çœŸçš„éœ€è¦å¤šå•ƒå‡ éï¼Œ

  2018-12-28 08:53

  ä½œè€…å›å¤

  å—¯å—¯ï¼Œè€Œä¸”è¿™ç¯‡æ˜¯ä¸‹ç¯‡çš„åŸºç¡€ğŸ˜„

  2018-12-28 09:43

- 

  Justin

  ä¸‹ä¸€ç« è€å¸ˆä¼šä¸ä¼šè®²èµ°æ™®é€šç´¢å¼•ï¼Œé”æ™®é€šç´¢å¼•çš„æ—¶å€™ï¼Œä¸»é”®ç´¢å¼•ï¼Œä»¥åŠå…¶ä»–ç´¢å¼•çš„åŠ é”é¡ºåºæˆ–è€…è§„åˆ™å‘¢ï¼Ÿå¾ˆæ˜¯å¥½å¥‡

  2018-12-28 00:50

  ä½œè€…å›å¤

  å—¯å—¯ï¼Œå°±æ˜¯è¿™äº›å†…å®¹ğŸ˜„

  è¿™ç¯‡æ–‡ç« æœ«å°¾çš„é—®é¢˜å¦‚æœä¸€çœ¼çœ‹æ‡‚çš„åŒå­¦åº”è¯¥çœ‹èµ·æ¥å°±è½»æ¾çš„

  2018-12-28 09:46

- 

  spraith

  ä»¥å‰æ²¡ç”¨è¿‡ for update è¯­å¥ï¼Œæˆ‘ä¸Šä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆåº”è¯¥æ‰¾åˆ°äº†ï¼ŒåŸæ¥ select è¯­å¥åªæœ‰åŠ äº† for update è¯­å¥æ‰ä¼šåŠ å†™é”çš„

  2019-01-12 03:11

  ä½œè€…å›å¤

  ä½ å¾—åˆ°äº†å®ƒğŸ˜†

  2019-01-12 13:02

- 

  spraith

  å›¾1çš„Q1è¯­å¥ï¼Œæ¯æ¬¡ select æ˜¯å¦éƒ½æ˜¯è‡ªåŠ¨åŠ å†™é”çš„ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£ä¸ºäº†å®ç°å¯é‡å¤è¯»æå‡ºæ¥çš„mvccå¥½åƒå°±æ²¡å¿…è¦äº†å•Šï¼Œå› ä¸ºåˆ«çš„äº‹åŠ¡éƒ½åªèƒ½ç­‰å¾…å‰é¢çš„å†™é”é‡Šæ”¾æ‰èƒ½å†å†™ï¼Œæ‰€ä»¥Q1æ‰€åœ¨çš„äº‹åŠ¡è‡ªç„¶å°±èƒ½å®ç°â€œå¯é‡å¤è¯»â€ï¼Œä¼¼ä¹ä¸éœ€è¦mvccã€‚
  æ±‚è€å¸ˆè§£ç­”

  2019-01-12 03:06

- 

  alias cd=rm -rf

  æ€è€ƒé¢˜çŒœæµ‹ï¼š
  å› ä¸ºsessionAè™½ç„¶æœ‰ç´¢å¼•ï¼Œä½†æ˜¯å› ä¸ºæ’åºéœ€è¦æ‰«æå…¨è¡¨ã€‚æ‰€ä»¥ä¸ºå…¨è¡¨å¢åŠ äº†gap lockã€‚å¯¼è‡´insertéƒ½éœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚
  æ˜¯å¦sessionAä¸åŠ order byï¼ŒsessionCå°±ä¸ç”¨blockäº†ï¼Ÿ

  2019-01-10 09:23

- 

  ä¸‰æœ¨ç¦¾

  è€å¸ˆï¼Œæˆ‘çš„æ•°æ®åº“ç‰ˆæœ¬æ˜¯5.6.39-logï¼Œå­˜å‚¨å¼•æ“ä¸ºinnodb,äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ä¸º REPEATABLE-READ
  CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8ï¼›
  ä½†æ˜¯æˆ‘åœ¨ä¸€ä¸ªsessionAæ‰§è¡Œbegin; select * from t where d=5 for update;
  å¾—åˆ° 5 | 5 | 5 | è¿™ä¸€è¡Œæ•°æ®
  sessionB æ‰§è¡Œupdate t set id=5 set id=0; ç„¶åè¿™æ¡è¯­å¥é˜»å¡
  sessionCæ‰§è¡Œinsert into t(id,c,d) values(1,1,5); ä¹Ÿé˜»å¡ï¼Œè·Ÿæ‚¨çš„å›¾1 çš„æ‰§è¡Œç»“æœä¸ä¸€æ ·ï¼Œä¸ºä»€ä¹ˆå•Šï¼Ÿ

  

  2019-01-07 20:46

  ä½œè€…å›å¤

  å›¾1æ˜¯ä¸ºäº†æ¨å¯¼â€œå¦‚æœä¸é˜»å¡ä¼šå‘ç”Ÿä»€ä¹ˆç°è±¡â€

  æœ€åæˆ‘ä»¬æ¨è®ºå‡ºæ¥éœ€è¦é˜»å¡

  å®é™…ä¸Šè·Ÿä½ éªŒè¯çš„è¿™ä¸ªç»“æœä¸€è‡´çš„

  2019-01-07 22:04